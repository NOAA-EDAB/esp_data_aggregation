---
title: "`r params$species_ID`"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    split_by: section
documentclass: book
github-repo: NOAA-EDAB/esp_data_aggregation

language:
  ui:
    chapter_name: "Section "

params: 
  species_ID: "Acadian redfish" # common name of species
  
  latlong_data: data # strata
  shape: shape # shapefile
  
  asmt_sum_data: data # bbmsy, ffmsy, assessment ratings
  asmt_sum_source: "assessmentdata::stockAssessmentSummary"

  diet_data: data # allfh diet data
  
  survey_data: data # survey data
  survey_source: "survdat"
  
  ricky_survey_data: data # ricky survey data

  rec_data: data # recreational catch (MRIP)
  
  asmt_data: data # assessmentdata:stockAssessmentData, for recruitment and catch
  asmt_source: "assessmentdata::stockAssessmentData"
  
  cond_data: data # Laurel's condition data
  
  risk_data: data # relative risk rankings
  
  com_data: data # commercial catch
  
  swept_data: data # swept area estimates
  
  risk_year_hist_data: data # historical risk by year
  
  risk_year_value_data: data # value risk by year
  
  risk_species_data: data # species risk
  
  cache: TRUE
  
  path: "" # figure path
---

# `r params$species` {-}

Placeholder



<!--chapter:end:index.Rmd-->


# Methods

Placeholder


## Stock identification
## Data collection and presentation
### `assessmentdata` methods
### `survdat` methods
## Risk assessment
### Risk across stocks
#### Suite of indicators
#### Individual indicators
### Risk within stocks

<!--chapter:end:01-methods.Rmd-->

# Habitat information

<!--chapter:end:02-habitat-title-page.Rmd-->

## Distribution

```{r, geo_functions, cache = params$cache}
source(here::here("R/full_report_functions", "get_latlong.R"))
source(here::here("R/full_report_functions", "map_strata_ecsa.R"))
```

```{r, geo_data_species}
latlong_data <- params$latlong_data[params$latlong_data$Species == species, ]
```

### Map of distribution
Strata maps were pulled and compiled using code from [NOAA/EDAB ECSA](https://github.com/NOAA-EDAB/ECSA). Please note, only fall and spring strata are shown on the map.
```{r, ecsa_map}
map_strata_ecsa(
  data = latlong_data,
  species_name = species
)
```

### Latitude and longitude ranges
Latitude and longitude ranges were calculated from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv) and [Bottom Trawl Survey (BTS) shapefiles](https://github.com/NOAA-EDAB/ECSA/tree/master/data/strata_shapefiles). The coordinate system is WGS84.
```{r, latlong}
data <- get_latlong(species, latlong_data, shapefile = params$shape) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

<!--chapter:end:03-latlong.Rmd-->



## Temperature
### Figures
### Summary
### Data

<!--chapter:end:04-temperature.Rmd-->



## Salinity
### Figures
### Summary
### Data

<!--chapter:end:05-salinity.Rmd-->



## Depth
### Figures

<!--chapter:end:06-depth.Rmd-->

## Habitat vulnerability

```{r, vul_functions}
source(here::here("R/full_report_functions", "plot_vulnerability.R"))

data <- read.csv(here::here("data", "Hare_et_al_2016_overall.csv"))
```

Habitat vulnerability information is sourced from the `ecodata` package. 

```{r, hab_vul}
data <- ecodata::habitat_vulnerability %>%
  dplyr::filter(Species == species) %>%
  dplyr::select(-Species)

data <- data[, c(8, 1:7)]

make_html_table(data,
  col_names = c(
    "EPU", "Habitat name", "Habitat vulnerability",
    "Importance of habitat to eggs/larvae",
    "Importance of habitat to juveniles/YOY",
    "Importance of habitat to adults",
    "Importance of habitat to spawning adults",
    "Overall species vulnerability"
  )
)
```

<!--chapter:end:07-habitat-vulnerability.Rmd-->

## Geographic distribution

Ricky Tabandera

```{r geography_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
library(dbutils)
library(survdat)
library(sf)
library("rnaturalearth")

```


Using fisheries independant data from bottom trawls in `survdat`. Several metrics of distribution in observed catches are calculated. Changes in distributuion can indicate changes in the geographic range of a species due to a variety of constraints such as food availability or physiologic limitations.The unweighted centroid is one metric that describes the geometric center of the observed range of `r params$species` in a given year. Calculated as the mean of latitude and longitude of all tows that captured the species of interest.The density of observations for `r params$species` was visualized using two-dimensional kernel density estimation on a grid as documented in `MASS::kde2d`. This density estimation is then visualized to indicate areas of greater or lesser probability of occurrence 


```{r geo_conc data wrangling }
source(here::here("R","common_names_survdat.r"))

survdata.w.codes<-Common_names_survdat(here::here("data","survdat_03022021_B.RDS"))


# selected.surv<-survdata.w.codes %>% 
#    dplyr::filter(common_name == params$species)
selected.surv<-survdata.w.codes %>% 
   dplyr::filter(common_name == "Pollock")



if(nrow(selected.surv>3)){
  
selected.surv.centroid<-selected.surv %>% dplyr::group_by(YEAR) %>% dplyr::summarise(lon=mean(LON),lat=mean(LAT))

}else("Not enough data")


```
### Figures


#### Density and distribution estimation by season
```{r, density_plot_setup_spring}

selected.surv.temp<-selected.surv %>%  dplyr::filter(YEAR <1970, SEASON=="SPRING") 

if(nrow(selected.surv)>3){
  
  if(nrow(selected.surv.temp)<200){
  #remove low capture years from this vis to make it consistantly run
  
selected.surv.temp<-selected.surv%>%  dplyr::filter(YEAR >1970)  
  
  
selected.surv.1970.plus<-selected.surv %>%
  dplyr::filter(YEAR >1970, SEASON=="SPRING")%>%
  dplyr::mutate(decade=ggplot2::cut_width(YEAR, width = 10, center =  1980 ))



latmin<-(min(selected.surv.centroid$lat)-3)
latmax<-(max(selected.surv.centroid$lat)+3)
lonmin<-(min(selected.surv.centroid$lon)-3)
lonmax<-(max(selected.surv.centroid$lon)+3)



ggplot2::ggplot(data = ecodata::coast) +
  ggplot2::geom_sf() +
  ggplot2::stat_density2d(aes(x=LON,y=LAT,fill = ..level..), alpha = .5,geom = "polygon", data = selected.surv.1970.plus) +
  nmfspalette::scale_fill_nmfs(palette="seagrass",discrete=FALSE, reverse=TRUE)+
  ggplot2::coord_sf(xlim=c(lonmin,lonmax), ylim=c(latmin,latmax))+
  scale_color_gradient(low = "blue", high = "red", name="Year")+
  xlab("Longitude")+
  ylab("Latitude")+
  theme(legend.position = 'none')+
  facet_wrap(~decade)+
  ggtitle("Spring")
  
}else{
  
#if there are  more than 200 observation pre 1970 then this visualization will capture that data  
selected.surv.1970<-selected.surv %>% filter(SEASON=="SPRING") %>%
  dplyr::mutate(decade=ggplot2::cut_width(YEAR, width = 10, center =  1980 ))



latmin<-(min(selected.surv.centroid$lat)-3)
latmax<-(max(selected.surv.centroid$lat)+3)
lonmin<-(min(selected.surv.centroid$lon)-3)
lonmax<-(max(selected.surv.centroid$lon)+3)



ggplot2::ggplot(data = ecodata::coast) +
  ggplot2::geom_sf() +
  ggplot2::stat_density2d(aes(x=LON,y=LAT,fill = ..level..), alpha = .5,geom = "polygon", data = selected.surv.1970) +
  nmfspalette::scale_fill_nmfs(palette="seagrass",discrete=FALSE, reverse=TRUE)+
  ggplot2::coord_sf(xlim=c(lonmin,lonmax), ylim=c(latmin,latmax))+
  scale_color_gradient(low = "blue", high = "red", name="Year")+
  xlab("Longitude")+
  ylab("Latitude")+
  theme(legend.position = 'none')+
  facet_wrap(~decade)
  
}
  
}else("No data")
  










```




```{r, density_plot_setup_fall}

selected.surv.temp.f<-selected.surv %>%  dplyr::filter(YEAR <1970, SEASON=="FALL") 

if(nrow(selected.surv)>3){
  
  if(nrow(selected.surv.temp.f)<200){
  #remove low capture years from this vis to make it consistantly run
  
selected.surv.temp<-selected.surv%>%  dplyr::filter(YEAR >1970)  
  
  
selected.surv.1970.plus<-selected.surv %>%
  dplyr::filter(YEAR >1970, SEASON=="FALL")%>%
  dplyr::mutate(decade=ggplot2::cut_width(YEAR, width = 10, center =  1980 ))



latmin<-(min(selected.surv.centroid$lat)-3)
latmax<-(max(selected.surv.centroid$lat)+3)
lonmin<-(min(selected.surv.centroid$lon)-3)
lonmax<-(max(selected.surv.centroid$lon)+3)



ggplot2::ggplot(data = ecodata::coast) +
  ggplot2::geom_sf() +
  ggplot2::stat_density2d(aes(x=LON,y=LAT,fill = ..level..), alpha = .5,geom = "polygon", data = selected.surv.1970) +
  nmfspalette::scale_fill_nmfs(palette="crustacean",discrete=FALSE, reverse=TRUE)+
  ggplot2::coord_sf(xlim=c(lonmin,lonmax), ylim=c(latmin,latmax))+
  scale_color_gradient(low = "blue", high = "red", name="Year")+
  xlab("Longitude")+
  ylab("Latitude")+
  theme(legend.position = 'none')+
  facet_wrap(~decade)+
  ggtitle("Fall")
  
}else{
  
#if there are  more than 200 observation pre 1970 then this visualization will capture that data  
selected.surv.1970<-selected.surv %>% filter(SEASON=="FALL") %>%
  dplyr::mutate(decade=ggplot2::cut_width(YEAR, width = 10, center =  1980 ))



latmin<-(min(selected.surv.centroid$lat)-3)
latmax<-(max(selected.surv.centroid$lat)+3)
lonmin<-(min(selected.surv.centroid$lon)-3)
lonmax<-(max(selected.surv.centroid$lon)+3)



ggplot2::ggplot(data = ecodata::coast) +
  ggplot2::geom_sf() +
  ggplot2::stat_density2d(aes(x=LON,y=LAT,fill = ..level..), alpha = .5,geom = "polygon", data = selected.surv.1970) +
  nmfspalette::scale_fill_nmfs(palette="crustacean",discrete=FALSE, reverse=TRUE)+
  ggplot2::coord_sf(xlim=c(lonmin,lonmax), ylim=c(latmin,latmax))+
  scale_color_gradient(low = "blue", high = "red", name="Year")+
  xlab("Longitude")+
  ylab("Latitude")+
  theme(legend.position = 'none')+
  facet_wrap(~decade)+
  ggtitle("Fall")
  
}
  
}else("No data")
  








```





#### Centroid of observations 

The average position of observations across all years of surveys 

```{r, centroid plot}
if(nrow(selected.surv.centroid<4)){
  world <- ne_countries(scale = "medium", returnclass = "sf")
latmin<-(min(selected.surv.centroid$lat)-1)
latmax<-(max(selected.surv.centroid$lat)+1)
lonmin<-(min(selected.surv.centroid$lon)-1)
lonmax<-(max(selected.surv.centroid$lon)+1)


ggplot2::ggplot(data = world) +
  geom_sf() +
  geom_point(data = selected.surv.centroid, aes(x=lon,y=lat,color=as.numeric(YEAR)))+
  ggrepel::geom_label_repel(data = selected.surv.centroid,aes(x=lon,y=lat,label=YEAR),max.overlaps =20 )+
  ggplot2::coord_sf(xlim=c(lonmin,lonmax), ylim=c(latmin,latmax))+
  scale_color_gradient(low = "blue", high = "red", name="Year")+
  xlab("Longitude")+
  ylab("Latitude")
}else("Not enough data")

```





<!--chapter:end:08-geographic-distribution.Rmd-->

# Biological information

<!--chapter:end:09-biological-title-page.Rmd-->



## Length
### Figures
#### Overview {-}
#### Summary statistics {-}
#### Risk {-}
### Summary
### Data

<!--chapter:end:10-length.Rmd-->



## von Bertalanffy growth curve
### Length at age growth curve

<!--chapter:end:11-von_b.Rmd-->



## Length at first maturity
### Size at first maturity 
### Maturity classification 
### Model results
### L50 differences between sexes

<!--chapter:end:12-length50maturity.Rmd-->



## Condition
### Figures
#### Length vs weight
#### Condition factor: Weight-volume
#### Condition factor: Relative weight
### Data
#### Length vs weight with weight-volume condition factor
#### Relative weight condition factor

<!--chapter:end:13-condition.Rmd-->



## Diet
### Figure
### Summary
### Data

<!--chapter:end:14-diet.Rmd-->



## Abundance
### Figures
#### Survey abundance (raw measurements)
##### Risk {-}
#### Survey abundance (swept area estimates)
#### Assessment abundance
##### Risk {-}
### Survey summary
### Data
#### Survey data (raw measurements)
#### Survey data (swept area estimates)
#### Assessment data

<!--chapter:end:15-abundance.Rmd-->

# Population information

<!--chapter:end:16-population-title-page.Rmd-->



## Biomass
### Figures
#### Survey biomass (raw measurements)
##### Risk {-}
#### Survey biomass (swept area estimates)
#### Assessment biomass
##### Risk {-}
### Survey summary
### Data
#### Survey data (raw measurements)
#### Survey data (swept area estimates)
#### Assessment data

<!--chapter:end:17-biomass.Rmd-->



## B/Bmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:18-bbmsy.Rmd-->



## Recruitment
### Figure
##### Risk {-}
### Data

<!--chapter:end:19-recruitment.Rmd-->



## Age diversity
### Figures
#### Age diversity {-}
#### Density plots of age {-}

<!--chapter:end:20-age-diversity.Rmd-->



## Climate vulnerability
### Figures
### Data

<!--chapter:end:21-climate-vulnerability.Rmd-->

# Socio-economic information

<!--chapter:end:22-socio-economic-title-page.Rmd-->



## Catch
### Figures
#### Stock assessment catch
##### Risk {-}
#### Recreational catch
##### Risk {-}
#### Commercial catch
##### Risk {-}
#### Commercial vs recreational catch
### Data
#### Stock assessment catch
#### Recreational catch
#### Commercial catch
#### Commercial vs recreational catch
#### Commercial, recreational, and stock assessment catch

<!--chapter:end:23-catch.Rmd-->



## F/Fmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:24-ffmsy.Rmd-->



## Revenue 
### Figure
##### Risk {-}
### Data

<!--chapter:end:25-revenue.Rmd-->


# Management information

Placeholder


## Stock assessment and data quality information

<!--chapter:end:26-management.Rmd-->


# Risk assessment

Placeholder


## Figures
### Relative to all other stocks
#### Comprehensive risk assessment {-}
#### Normalized rank of magnitude of change compared to historical value by year {-}
#### Normalized rank of value in each year {-}
### Within a single stock
## Data
### Relative to all other stocks
#### Comprehensive risk assessment {-}
#### Normalized rank of magnitude of change compared to historical value by year {-}
#### Normalized rank of value in each year {-}
### Value within each stock, ranked by year 

<!--chapter:end:27-risk-assessment.Rmd-->

