## Geographic distribution

Ricky Tabandera

```{r geography_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
library(dbutils)
library(survdat)
library(sf)
library("rnaturalearth")
library("rnaturalearthdata")
```


Using fisheries independant data from bottom trawls in `survdat`. Several metrics of distribution in observed catches are calculated. Changes in distributuion can indicate changes in the geographic range of a species due to a variety of constraints such as food availability or physiologic limitations.The unweighted centroid is one metric that describes the geometric center of the observed range of `r params$species` in a given year. Calculated as the mean of latitude and longitude of all tows that captured the species of interest.The density of observations for `r params$species` was visualized using two-dimensional kernel density estimation on a grid as documented in `MASS::kde2d`. This density estimation is then visualized to indicate areas of greater or lesser probability of occurrence 


```{r geo_conc data wrangling }
source(here::here("R","common_names_survdat.R"))

survdata.w.codes<-Common_names_survdat(here::here("data","survdat_03022021_B.RDS"))


selected.surv<-survdata.w.codes %>% 
   dplyr::filter(common_name == params$species)




# testing other centroid functions
# surv.sub<-selected.surv %>% dplyr::select(LON,LAT,YEAR)
# surv.sub.year <-surv.sub %>% dplyr::group_split(YEAR)
# 
# ####works
# centroid.list<-purrr::map(surv.sub.year,~geosphere::centroid(.x[,1:2]))
# 
# selected.surv.centroid<-data.table::rbindlist(purrr::map( centroid.list, data.table::as.data.table))
# 
# selected.surv.centroid<-cbind(selected.surv.centroid,unique(selected.surv$YEAR))
# 
# colnames(selected.surv.centroid)<-c("lon","lat","year")
# 
# selected.surv.centroid.sf<-st_as_sf(selected.surv.centroid, coords = c("lon", "lat"), crs = 4326)


if(nrow(selected.surv>3)){
  
selected.surv.centroid<-selected.surv %>% dplyr::group_by(YEAR) %>% dplyr::summarise(lon=mean(LON),lat=mean(LAT))

}else("Not enough data")


```
### Figures


#### Density and distribution estimation
```{r}
if(nrow(selected.surv>3)){
  #remove low capture years from this vis to make
  
selected.surv<-selected.surv %>%
  dplyr::filter(YEAR >1970)%>%
  dplyr::mutate(decade=ggplot2::cut_width(YEAR, width = 10, center =  1980 ))


world <- ne_countries(scale = "medium", returnclass = "sf")
latmin<-(min(selected.surv.centroid$lat)-1)
latmax<-(max(selected.surv.centroid$lat)+1)
lonmin<-(min(selected.surv.centroid$lon)-1)
lonmax<-(max(selected.surv.centroid$lon)+1)



ggplot2::ggplot(data = world) +
  ggplot2::geom_sf() +
  ggplot2::stat_density2d(aes(x=LON,y=LAT,fill = ..level..), alpha = .5,geom = "polygon", data = selected.surv) +
  nmfspalette::scale_fill_nmfs(palette="crustacean",discrete=FALSE, reverse=TRUE)+
  ggplot2::coord_sf(xlim=c(lonmin,lonmax), ylim=c(latmin,latmax))+
  scale_color_gradient(low = "blue", high = "red", name="Year")+
  xlab("Longitude")+
  ylab("Latitude")+
  theme(legend.position = 'none')+
  facet_wrap(~decade)
  


  

}else("Not enough data")

```

#### Centroid of observations 

The average position of observations across all years of surveys 

```{r, centroid plot}
if(nrow(selected.surv.centroid<4)){
  world <- ne_countries(scale = "medium", returnclass = "sf")
latmin<-(min(selected.surv.centroid$lat)-1)
latmax<-(max(selected.surv.centroid$lat)+1)
lonmin<-(min(selected.surv.centroid$lon)-1)
lonmax<-(max(selected.surv.centroid$lon)+1)


ggplot2::ggplot(data = world) +
  geom_sf() +
  geom_point(data = selected.surv.centroid, aes(x=lon,y=lat,color=as.numeric(YEAR)))+
  ggrepel::geom_label_repel(data = selected.surv.centroid,aes(x=lon,y=lat,label=YEAR),max.overlaps =20 )+
  ggplot2::coord_sf(xlim=c(lonmin,lonmax), ylim=c(latmin,latmax))+
  scale_color_gradient(low = "blue", high = "red", name="Year")+
  xlab("Longitude")+
  ylab("Latitude")
}else("Not enough data")

```




