
## L50 maturity


Ricky Tabandera

```{r setup_L50, cache = params$cache}
#knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(nlstools))
library(dbutils)
library(survdat)

```

### Size at first maturity 

L50 or length at which 50%  maturity can be calculated using differing methods. Using Data sourced from `survdat` that consist of visual sexual maturity determination and length measurements. Here, L50 is estimated by fitting a logistic generalized linear model to gonadal maturity and body length measurements and estimating the inflection point of the logistic model. This point represents the size where the individual has 50% odds of being mature. Decade variations of this parameter are investigated utilizing decade as a additive and interaction term in the model specification.

The relationship between sexual maturity by body size is a well established life history parameter. L50 is a useful metric in fisheries to identify sizes that are able to reproduce. This information can be used to inform regulation as to minimum catch size that should allow for a significant portion of the population to spawn and contribute genetic information to sustain the stock. Changes in this parameter can signal population/evolutionary pressures on the stock with reduction in this size potentially indicating excessive fishing pressure.



```{r data wrangling, cache = params$cache, cache.lazy = FALSE}

survdata<-readRDS(here::here("data", "survdat_pull_bio.rds"))

survdata<-survdata %>% mutate(SVSPP=as.numeric(SVSPP))
stock_list_all_strata <- read.csv("https://raw.githubusercontent.com/NOAA-EDAB/ECSA/master/data/stock_list.csv")
stock_list_all_strata<-stock_list_all_strata %>% rename(SVSPP=svspp)
stock_list<-stock_list_all_strata %>% dplyr::distinct(SVSPP,.keep_all =T)

survdata.w.codes<-inner_join(survdata, stock_list, by= "SVSPP" )



selected.surv<-survdata.w.codes %>%
  dplyr::mutate(common_name = common_name %>%
                  stringr::str_to_sentence()) %>%
  dplyr::filter(common_name == species & YEAR>1980)

#con <- connect_to_database(server="sole",uid="RTABANDERA")
#surv.maturity<-get_maturity(con)
#surv_maturity<-surv.maturity$data
#write.csv(surv.maturity, file = "surv_maturity_codes.csv")



#only take records with a maturity status associated

selected.surv.clean<-selected.surv %>% drop_na(MATURITY) 



#recode sexed fish to readable names
#sex codes 1 male, 2 female, 4 transitional, 0 unsexed/unknown   
selected.surv.clean$MATURITY <-recode(selected.surv.clean$MATURITY, "D"="Mature" , "I"="Immature", "R"="Mature", "S"= "Mature", "T"= "Mature", "U"="Mature")
selected.surv.f<- selected.surv.clean %>% filter(SEX=="female" | MATURITY !="X")

# conditionally run models based on having more than 3 rows 
if(nrow(selected.surv.f)>3){



# X= unknown , I = immature, D= developing, R S T U convert to developed


#bin the years of fish into decades to compare if model parameters are chaging 
selected.surv.f<-selected.surv.f %>% mutate(decade=ggplot2::cut_width(YEAR, width = 10, boundary = 1980))
levels(selected.surv.f$decade)<-c( "1980","1990", "2000","2010")
#recode the maturity col into factor
selected.surv.f<-selected.surv.f %>% mutate(MATURITY=as.factor(MATURITY))


maturity.mod<-glm(MATURITY~LENGTH+decade+LENGTH*decade, data=selected.surv.f, family=binomial)



pretty_mod<-papeR::prettify(summary(maturity.mod))

#summary(maturity.mod)  
}else("Not enough data to fit model")
  




```

### Model results

`r if(nrow(selected.surv.f)>3){"If the overall model is significant, there is support for the relationship between sexual maturity and body size. This model can predict the size where there are 50% odds of the indevidual is sexually mature. The results table below displays the L50 for different decades. "}` 

```{r, model table, echo=FALSE, message=FALSE, warning=FALSE}

if(nrow(selected.surv.f)>3){
 
knitr::kable(pretty_mod, digits = 3)
}
```

### L50 across time

`r if(nrow(selected.surv.f)>3){"The significance of differences among decades can be determined by referencing the model summary table above   "}`

```{r model results and L50}
if(nrow(selected.surv.f)>3){
   if(summary(maturity.mod)$coefficients[,4][1]<0.05){


L50.1980<-(-coef(maturity.mod)[1])/coef(maturity.mod)[2] # 1980
L50.1990<-(-(coef(maturity.mod)[1]+coef(maturity.mod)[3]))/(coef(maturity.mod)[2]+coef(maturity.mod)[6]) # 1990
L50.2000<-(-(coef(maturity.mod)[1]+coef(maturity.mod)[4]))/(coef(maturity.mod)[2]+coef(maturity.mod)[7]) # 2000
L50.2010<-(-(coef(maturity.mod)[1]+coef(maturity.mod)[5]))/(coef(maturity.mod)[2]+coef(maturity.mod)[8]) # 2010

L50<-data.frame(L50.1980,L50.1990,L50.2000,L50.2010)
row.names(L50)<-c("Length at 50% maturity")
colnames(L50)<-c("1980","1990","2000","2010")
L50.p<-papeR::prettify(L50)
knitr::kable(L50.p, digits = 3)
}}else("Non-significant")


```




```{r, probability plot}

if(nrow(selected.surv.f)>3){
   if(summary(maturity.mod)$coefficients[,4][1]<0.05){
decade1980<-boot::inv.logit(predict(maturity.mod, data.frame(LENGTH=seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)), decade=rep("1980",length(seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)))), type="response")))
decade1990<-boot::inv.logit(predict(maturity.mod, data.frame(LENGTH=seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)), decade=rep("1990",length(seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)))), type="response")))
decade2000<-boot::inv.logit(predict(maturity.mod, data.frame(LENGTH=seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)), decade=rep("2000",length(seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)))), type="response")))
decade2010<-boot::inv.logit(predict(maturity.mod, data.frame(LENGTH=seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)), decade=rep("2010",length(seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH)))), type="response")))
selected.surv.LENGTH<-seq(min(selected.surv.f$LENGTH),max(selected.surv.f$LENGTH))

selected.surv.simlulation<-data.frame(decade1980, decade1990, decade2000,decade2010,selected.surv.LENGTH)
selected.surv.simlulation<-selected.surv.simlulation %>% pivot_longer(!selected.surv.LENGTH, names_to="decade", values_to="pred")


selected.surv.simlulation %>%
  ggplot(aes(x=selected.surv.LENGTH,y=pred, color=decade))+
  geom_line(size=3)+
  xlab("Length (cm)")+
  ylab("Probability")+
  ggtitle("Length at 50% maturity of" , subtitle = params$species)+
  annotate("text", label=c("Mature","Immature"), x=30,y= c(1.05,-.05))+
  geom_hline(yintercept=c(1,0,0.5))+
  scale_color_manual(labels=c("<1980"," 1981-1990","1991-2000",">2010"), values =c( "blue","firebrick","darkviolet","deepskyblue"), name="Decade")+
  theme_minimal()
}}else("Non-significant")


```


