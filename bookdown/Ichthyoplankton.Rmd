
## "Icthyoplankton"

Ricky Tabandera

```{r ich-setup}
knitr::opts_chunk$set(echo = TRUE)
# install.packages("R.matlab")
# library(R.matlab)
suppressPackageStartupMessages(library(tidyverse))
library(sf)
```


#### Ichyoplankton surveys  that captured `r params$species` larva.
Ichthyoplankton surveyed during the Marine Resources Monitoring, Assessment, and Prediction (MARMAP; 1977-1987) and Ecosystem Monitoring (EcoMon; 1999-2008) programs.  Stations were stratified from Cape Hatteras, North Carolina to Cape Sable, Nova Scotia and captured multiple taxa of planktonic organisms and enumerated their mean abundance and relative proportion of catch. Surveys were conducted year round, however catches are averaged to two month intervals(i.e. season 1 represents January-February, Season 6; November-December). 


```{r, ich-wrangle}
# used to convert the .mat file into well behaved data frame

# 
# ich.data.raw<-readMat(here::here("Data","ichthyoplankton_all_species.mat"))
# ich.data<-data.frame(matrix(unlist(ich.data.raw), nrow=length(ich.data.raw$taxa), ncol = (length(ich.data.raw))))
# ich.names<-c("taxa" ,"year", "season", "strata" ,"lat", "lon" ,"area" ,"mean.abund","rel.proportion")
# colnames(ich.data)<-ich.names
# ich.data <- ich.data %>%   mutate_at(vars(-taxa) ,as.numeric)
# Save the data to a useful format

# saveRDS(ich.data, file="ichthyoplankton_MARMAP_ECOMON.rds")

#January-February, March-April, May-June, July-August, September-October, and November-December)

ich.data<-read_rds(here::here("data","ichthyoplankton_MARMAP_ECOMON.rds"))

#recode season as month for readability
#January-February, March-April, May-June, July-August, September-October, and November-December)

ich.data<-ich.data %>% mutate(season.month=dplyr::recode_factor(season, "1"="January-February", "2"="March-April", "3"="May-June", "4"="July-August", "5"="September-October",  "6"="November-December" ))

stock_list_all_strata <- read.csv("https://raw.githubusercontent.com/NOAA-EDAB/ECSA/master/data/stock_list.csv")

#restructure the taxa to join with common name data set
ich.data<-ich.data %>% dplyr::mutate(sci_name=stringr::str_replace(taxa, "_", " ")) 
ich.data<-ich.data %>% mutate(sci_name =stringr::str_to_sentence(sci_name))

ich.data.common<-dplyr::left_join(ich.data, stock_list_all_strata, by = "sci_name")


#filter to just one species of interest
selected_spp<-ich.data.common %>% filter(common_name ==params$species)


```



### Relative proportion and mean abundance of `r params$species`



```{r Relative_proportion plot, fig.cap = paste("Black sea bass", "larva relative proportion")}

if(nrow(selected_spp)>5){
   selected_spp <- selected_spp %>%
     dplyr::mutate(decade = ggplot2::cut_width(year, width = 10, center = 1980))
selected_spp.1<-dplyr::filter_all(selected_spp, ~!is.na(.))

selected_spp.1 <- selected_spp.1 %>%
    dplyr::mutate(rel.prop.bin = ggplot2::cut_interval(rel.proportion, length = 25))


geo_lim.1<-selected_spp.1 %>% dplyr::summarise(latmin= min(lat, na.rm = TRUE )-1,
                                   latmax= max(lat, na.rm = TRUE)+1,
                                   lonmin= min(lon, na.rm = TRUE)-1,
                                   lonmax= max(lon, na.rm = TRUE)+1)





 ggplot2::ggplot()+
   ggplot2::geom_sf()+
   ggplot2::coord_sf(xlim = c(geo_lim$lonmin - 1, geo_lim$lonmax + 1), 
                      ylim = c(geo_lim$latmin - 1, geo_lim$latmax + 1)) +
   ggplot2::geom_point(data =  selected_spp.1 ,ggplot2::aes(x=lon,y=lat,  size=(mean.abund),color=rel.prop.bin))+
   ggplot2::facet_grid(decade~season.month)+
   nmfspalette::scale_color_nmfs("seagrass")+
      ggplot2::geom_sf(data = ecodata::coast)+
   ggplot2::coord_sf(xlim = c(geo_lim.1$lonmin + 1, geo_lim.1$lonmax - 1), 
                      ylim = c(geo_lim.1$latmin + 1, geo_lim.1$latmax - 1))+
   ggplot2::labs( size="Mean abundance", color="Relative proportion (%)")+
   ggplot2::xlab("Longitude")+
    
   ggplot2::ylab("Latitude") 
 
 
 
 
}else("No data")


#depreciated density plot of stations

# if(nrow(selected_spp)>4){
#    
#    selected_spp <- selected_spp %>%
#     dplyr::mutate(decade = ggplot2::cut_width(year, width = 10, center = 1980))
#   
#   
#   
#   
# 
# 
# geo_lim<-selected_spp %>% summarise(latmin= min(lat, na.rm = TRUE )-1,
#                                    latmax= max(lat, na.rm = TRUE)+1,
#                                    lonmin= min(lon, na.rm = TRUE)-1,
#                                    lonmax= max(lon, na.rm = TRUE)+1)
# 
# 
# ggplot(data= ecodata::coast )+
#    ggplot2::stat_density2d(aes( x = lon, 
#                                 y = lat, 
#                                fill = ..density..),
#                                geom = "raster",
#                                contour=FALSE,
#                                alpha = 0.9, data = selected_spp)+
#    geom_sf()+
#    ggplot2::coord_sf(xlim = c(geo_lim$lonmin+1.2 , geo_lim$lonmax-1.2), 
#                       ylim = c(geo_lim$latmin+1.2 , geo_lim$latmax-1.2 )) +
#    scale_color_gradient(low = "blue", 
#                          high = "red", 
#                          name = "Year") +
#    xlab("Longitude") +
#    ylab("Latitude")
# 
# }else("Not enough data") 
   
   


```

