---
title: "test"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    split_by: section
documentclass: book
github-repo: NOAA-EDAB/esp_data_aggregation
params:
  lag: 0 # lag for correlations
  remove_recent: FALSE
  cache: FALSE
  stock: 
  epu: MAB # epu options: GB, GOM, MAB, SS, All, OTHER, MA, NE, all 
  region: "" # the stock region
  path: "" # figure path
---

# `r params$stock` {-}
Stock region: `r params$region`

EPU: `r params$epu`

# Introduction

These are preliminary regressions that compare `r params$region` `r params$stock` catch, abundance, recruitment, and F to various indicators in the `r paste(params$epu, collapse = ", ")` Environmental Protection Units (EPUs) taken from the `ecodata` package. The indicators are lagged by `r params$lag` years.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = TRUE, 
                      cache = params$cache,
                      results = "asis",
                      fig.width = 8, 
                      fig.align = 'center',
                      fig.path = params$path)

library(ggplot2)
`%>%` <- dplyr::`%>%`

source(here::here("R/regressions", "indicator_functions_general.R"))

stock <- assessmentdata::stockAssessmentData %>% 
  dplyr::filter(Species == params$stock) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(max_year = max(AssessmentYear)) %>%
  dplyr::filter(AssessmentYear == max_year) %>%
  dplyr::rename(Time = Year)

if(params$remove_recent){
  max_year <- max(stock$Time)
  stock <- stock %>%
    dplyr::filter(Time <= (max_year - 10))
} 

output <- c()

```

# Regression analysis

All regressions are simple linear correlations assessed at the p < 0.5 level. Please note, due to the large number of indicators tested, a certain amount of statistically significant results are expected even if there are no underlying mechanistic connections. These correlations do not necessarily imply causation.

### Chlorophyll
```{r, chl}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
                  stringr::str_replace_all("_", "\n") %>%
                  stringr::str_replace_all(" ", "\n"))
```

```{r, render}
#render_indicator(test)
```


```{r, epu}
if("EPU" %in% colnames(test)){
  eval_epu = sum(test$EPU %in% params$epu) > 0 # only evaluate if the selected epu is in the indicator data set
} else eval_epu = TRUE # always evaluate if there is no epu for the indicator
```

````{r, prep_data, eval = eval_epu}
# make sure test data has the right structure 
if("EPU" %in% colnames(test)){
  test <- test %>%
    dplyr::filter(EPU %in% params$epu)
}

if("Units" %in% colnames(test)){
  test <- test %>%
    dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
}

if("Value" %in% colnames(test)){
  test <- test %>%
    dplyr::rename(Val = Value)
}

# mean data by year
test <- test %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Var, Time) %>%
  dplyr::summarise(new_val = mean(Val)) %>%
  dplyr::rename(Val = new_val) %>%
  dplyr::ungroup()

n_years <- length(unique(test$Time))
n_var <- length(unique(test$Var))
n_measurements <- length(test$Time)

if(n_measurements > n_years * n_var &
   n_measurements > 0){
  test <- test %>%
    dplyr::mutate(Var = paste(Var, "(annual mean)", sep = "\n"))
}
```

```{r, print_data}
stock %>% knitr::kable()
test %>% knitr::kable()
```

```{r, correlation_summary2, eval = eval_epu}
# correlation summary
print(correlation_summary(stock = stock, 
                                            eco = test, 
                                            lag = params$lag))
```

```{r, correlation_summary, eval = eval_epu}
# correlation summary
output <- rbind(output, correlation_summary(stock = stock, 
                                            eco = test, 
                                            lag = params$lag))
```

#### Figures {-}
```{r, fig.height = 10, eval = eval_epu}
plot_correlation(stock = stock, 
                 eco = test, 
                 lag = params$lag)
```

```{r, , eval = (eval_epu == FALSE)}
print("No data for the EPU selected")
```

#### Regression statistics {-}
```{r, results = "asis", eval = eval_epu}
correlation_data(stock = stock, 
                 eco = test, 
                 lag = params$lag)
```

```{r, , eval = (eval_epu == FALSE)}
print("No data for the EPU selected")
```
