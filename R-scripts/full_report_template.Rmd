---
title: "`r params$species_ID`"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"

output: 
  html_document:
    toc: FALSE
    number_sections: FALSE
    toc_float: 
      collapsed: FALSE
      title: "`r params$species_ID`"
    toc_depth: 2

params: 
  species_ID: "Acadian redfish" # common name of species
  
  latlong_data: data # strata
  shape: shape # shapefile
  
  asmt_sum_data: data # bbmsy, ffmsy, assessment ratings
  asmt_sum_source: "assessmentdata::stockAssessmentSummary"

  diet_data: data # allfh diet data
  
  survey_data: data # survey data
  survey_source: "survdat"

  rec_data: data # recreational catch (MRIP)
  
  asmt_data: data # assessmentdata:stockAssessmentData, for recruitment and catch
  asmt_source: "assessmentdata::stockAssessmentData"
  
  cond_data: data # Laurel's condition data
  
  risk_data: data # relative risk rankings
  
  com_data: data # commercial catch
  
  swept_data: data # swept area estimates

---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      fig.width = 8, fig.align = 'center')

library(ggplot2)

`%>%` <- dplyr::`%>%`
```

```{r, functions, include = FALSE}
source(here::here("R", "character_to_factor.R"))
source(here::here("R/full_report_functions", "get_diet.R"))
source(here::here("R/full_report_functions", "get_latlong.R"))
source(here::here("R/full_report_functions", "get_bf.R"))
source(here::here("R/full_report_functions", "get_survdat_info.R"))
source(here::here("R/full_report_functions", "get_length.R"))
source(here::here("R/full_report_functions", "get_rec_catch.R"))
source(here::here("R/full_report_functions", "get_lw.R"))
source(here::here("R/full_report_functions", "get_assessment.R"))
source(here::here("R/full_report_functions", "get_relative_weight.R"))
source(here::here("R/full_report_functions", "get_com_catch.R"))
source(here::here("R/full_report_functions", "get_com_money.R"))
source(here::here("R/full_report_functions", "compare_rec_com.R"))
source(here::here("R/full_report_functions", "get_swept.R"))
source(here::here("R/full_report_functions", "map_strata_ecsa.R"))
```

```{r, data, include = FALSE}
species <- params$species_ID

latlong_data <- params$latlong_data
latlong_data <- latlong_data[latlong_data$Species == species, ]

asmt_sum_data <- params$asmt_sum_data
asmt_sum_data <- asmt_sum_data[asmt_sum_data$Species == species, ]

survey_data <- params$survey_data
survey_data <- survey_data[survey_data$Species == species, ]

ad_rating_data <- asmt_sum_data %>% 
  dplyr::select(Species, Region, Assessment.Year, Last.Data.Year,
                Biological.Input.Data, Life.History.Data, 
                Composition.Input.Data, Ecosystem.Linkage, FSSI.Stock.,
                Review.Result) %>%
  dplyr::rename(`Assessment Year` = Assessment.Year,
                         `Last Data Year` = Last.Data.Year,
                         `Biological Data Rating (2019)` = Biological.Input.Data,
                         `Biological Data Rating (before 2019)` = Life.History.Data,
                         `Size Data Rating` = Composition.Input.Data,
                         `Ecosystem Linkage Data Rating` = Ecosystem.Linkage,
                         `FSSI status` = FSSI.Stock.,
                         `Review Result` = Review.Result)

diet_data <- params$diet_data
diet_data <- diet_data[diet_data$Species == species, ]

rec_data <- params$rec_data
rec_data <- rec_data[rec_data$Species == species, ]

asmt_data <- params$asmt_data
asmt_data <- asmt_data[asmt_data$Species == species, ]

cond_data <- params$cond_data
cond_data <- cond_data[cond_data$Species == species, ]

risk_data <- params$risk_data
risk_data <- risk_data[risk_data$Species == species, ]

com_data <- params$com_data
com_data <- com_data[com_data$Species == species, ]

swept_data <- params$swept_data
swept_data <- swept_data[swept_data$Species == species, ]

```

```{r, bf_status}
if(length(asmt_sum_data$Species) > 1){
  list_regions <- split(unique(asmt_sum_data$Region), f = list(unique(asmt_sum_data$Region)))
  bbmsy2 <- purrr::map(list_regions, ~status(data = asmt_sum_data, regions = .x, metric = "bbmsy"))
  ffmsy2 <- purrr::map(list_regions, ~status(data = asmt_sum_data, regions = .x, metric = "ffmsy"))
} else {
  bbmsy2 <- "UNKNOWN"
  ffmsy2 <- "UNKNOWN"
}

```

```{r, legend}
# set colors and linetypes to be constant for all regions
reg <- c(asmt_sum_data$Region, asmt_data$Region) %>% unique()

lines <- 1:length(reg)
names(lines) <- reg

colors <- nmfspalette::nmfs_palette("regional web")(length(reg))
names(colors) <- reg

```

This is a preliminary report of previously collected data. This report is pulling information on all Northeast `r species` stocks.

# {.tabset .tabset-fade}

## Methods

### General methods
Northeast stocks were identified from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv).

Data sources for each analysis are identified in the Results.

All continuous temporal data were plotted against time. If there were 30 or more years of data, a geom_gls regression line was fit (yellow = significant increase; purple = significant decrease; no line = no significant trend). If there were fewer than 30 years of data, no regression was fit.

### `assessmentdata` methods
Stock assessment and data quality information were compiled into a summary table.

B/Bmsy was classified as "DANGER" if it was below 1 and "GOOD" if it was above 1.

F/Fmsy was classified as "DANGER" if it was above 1 and "GOOD" if it was below 1.


### `survdat` methods
`survdat` data with zero abundance were not included in this analysis. Abundance and biomass were summed for each year and season. All other metrics were averaged for each year and season. The tables show summary statistics for the entire time series and for the most recent 5 years in the time series. 

## Results {.tabset .tabset-fade}

### Indicator time series {.tabset .tabset-fade}

#### Latitude and longitude
Strata maps were pulled and compiled using code from [NOAA/EDAB ECSA](https://github.com/NOAA-EDAB/ECSA). Please note, only fall and spring strata are shown on the map.
```{r, ecsa_map}
map_strata_ecsa(data = latlong_data,
                species_name = species)
```

Latitude and longitude ranges were calculated from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv) and [Bottom Trawl Survey (BTS) shapefiles](https://github.com/NOAA-EDAB/ECSA/tree/master/data/strata_shapefiles). The coordinate system is WGS84.
```{r, latlong}
data <- get_latlong(species, latlong_data, shapefile = params$shape) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))

```

#### Stock assessment and data quality information
Stock assessment and data quality information were pulled from ``r params$asmt_sum_source``.
```{r, quality}
data <- ad_rating_data %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### B/Bmsy  {.tabset .tabset-fade .tabset-pills}
B/Bmsy data were pulled from ``r params$asmt_sum_source``.

The most recent status of B/Bmsy is: `r bbmsy2`

##### Figure
```{r, bbmsy_fig} 
if("GOOD" %in% bbmsy2 | "DANGER" %in% bbmsy2){
  plot_bbmsy(asmt_sum_data[which(is.na(asmt_sum_data$B.Bmsy) == FALSE), ], 
             ytitle = "B / Bmsy",
             lin = lines,
             col = colors)
} else print("NO DATA")
```

##### Data
```{r, bbmsy_data}
data <- asmt_sum_data[which(is.na(asmt_sum_data$B.Bmsy) == FALSE), ] %>% 
                dplyr::select(Region, B.Year, B.Bmsy) %>%
                dplyr::mutate(B.Bmsy = B.Bmsy %>% round(digits = 2)) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Region", "Year", "B/Bmsy"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### F/Fmsy {.tabset .tabset-fade .tabset-pills}
F/Fmsy data were pulled from ``r params$asmt_sum_source``.

The most recent status of F/Fmsy is: `r ffmsy2`

##### Figure
```{r, ffmsy}
if("GOOD" %in% ffmsy2 | "DANGER" %in% ffmsy2){
 plot_ffmsy(asmt_sum_data[which(is.na(asmt_sum_data$F.Fmsy) == FALSE), ],
                      ytitle = "F / Fmsy",
             lin = lines,
             col = colors)
} else print("NO DATA")
```

##### Data
```{r, ffmsy_data}
data <- asmt_sum_data[which(is.na(asmt_sum_data$F.Fmsy) == FALSE), ] %>% 
                dplyr::select(Region, F.Year, F.Fmsy) %>%
                dplyr::mutate(F.Fmsy = F.Fmsy %>% round(digits = 2)) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
                    colnames = c("Region", "Year", "F/Fmsy"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Revenue {.tabset .tabset-fade .tabset-pills}
Commercial catch data were downloaded from [NOAA FOSS](https://foss.nmfs.noaa.gov/apexfoss/f?p=215:200:4615327020711::NO:::).

##### Figure
```{r, revenue}
if(length(com_data$Species) > 0){
  plot_com_money(com_data)
} else print("NO DATA")
```

##### Data
```{r, revenue_data}
data <- com_data %>% 
                dplyr::select(Year, State, Dollars_adj, Pounds) %>%
                dplyr::mutate(Dollars_adj = Dollars_adj %>% 
                                round(digits = 0) %>%
                                format(big.mark = ","),
                              State = State %>% 
                                stringr::str_to_title(),
                              Pounds = Pounds %>%
                                format(big.mark = ",")) %>%
                dplyr::rename("Revenue (2019 dollars)" = "Dollars_adj",
                              "Commercial catch (lb)" = "Pounds") %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Recruitment {.tabset .tabset-fade .tabset-pills}
Recruitment data were pulled from ``r params$asmt_source``. Separate geom_gls() functions were fit for each region; trend lines are only shown when the trend was statistically significant, so some plots may have fewer trend lines than regions.

##### Figure
```{r, recruitment}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Recruitment")) > 0){
plot_asmt(asmt_data, 
          metric = "Recruitment", 
          ytitle = "Recruitment",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

##### Data
```{r, recruit_data}
data <- asmt_data %>% 
                dplyr::filter(Metric == "Recruitment") %>%
                dplyr::select(-Species, -Metric) %>%
                dplyr::mutate(Value = Value %>%
                              format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Diet {.tabset .tabset-fade .tabset-pills}
Diet data were compiled from [existing data](https://github.com/Laurels1/Condition/blob/master/data/allfh.RData). For analysis, all geographic samples were grouped by season, year, and region, and only year-season-region combinations with more than 20 predators sampled were considered. Prey items that made up more than 5% of the predator's diet in at least one year-season-region were identified to the broad category level; all other prey are grouped into the "other" category.

##### Figure
```{r, diet}
if(length(diet_data$Species) >= 1){
  get_diet_plot(data = diet_data)
} else print("NO DATA")
```

##### Summary
```{r, diet_summary}
if(length(diet_data$Species) >= 1){
  get_diet_table(data = diet_data)
} else print("NO DATA")
```

##### Data
```{r, diet_data}
diet_data2 <- diet_data %>%
    dplyr::filter(pyamtw > 0) %>%
    
    # only look at season/year combinations with >20 predator samples
    dplyr::group_by(year, season, Region) %>%
    dplyr::mutate(n_predators = fish_id %>% unique() %>% length()) %>%
    dplyr::filter(n_predators > 20) %>%
    dplyr::group_by(year, season, Region, n_predators, gensci) %>%
    dplyr::summarise(total_weight = sum(pyamtw)) %>%
    dplyr::mutate(proportion = total_weight/sum(total_weight),
                  proportion = proportion %>%
                    round(digits = 3),
                  total_weight = total_weight %>%
                    round(digits = 2))  %>%
  character_to_factor()
      
diet_data2$gensci <- diet_data2$gensci %>% 
  stringr::str_replace("_", " ") %>%
  stringr::str_to_sentence()

DT::datatable(diet_data2, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", "Number of fish", 
                       "Prey category", "Prey weight", "Prey proportion"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Temperature {.tabset .tabset-fade .tabset-pills}

Surface and bottom temperature data were pulled from ``r params$survey_source``. 

##### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, temp}
if(sum(is.na(survey_data$SURFTEMP)) < length(survey_data$SURFTEMP)){
  generate_plot(survey_data,
              variable = "SURFTEMP", 
              ytitle = "Surface temperature")
} else print("NO SURFACE DATA")

if(sum(is.na(survey_data$BOTTEMP)) < length(survey_data$BOTTEMP)){
  generate_plot(survey_data,
              variable = "BOTTEMP", 
              ytitle = "Bottom temperature")
} else print("NO BOTTOM DATA")
```

##### Summary
```{r, temp_summary}
if(sum(is.na(survey_data$SURFTEMP)) < length(survey_data$SURFTEMP)){
  generate_table(survey_data,
              variable = "SURFTEMP", 
              cap = "Surface temperature")
} else print("NO SURFACE DATA")

if(sum(is.na(survey_data$BOTTEMP)) < length(survey_data$BOTTEMP)){
  generate_table(survey_data,
              variable = "BOTTEMP", 
              cap = "Bottom temperature")
} else print("NO BOTTOM DATA")
```

##### Data
```{r, temp_data}
data <- survey_data %>% 
                dplyr::select(YEAR, SEASON, Region, date, 
                              fish_id, SURFTEMP, BOTTEMP) %>%
                dplyr::filter(SURFTEMP > 0 | BOTTEMP > 0) %>%
                dplyr::group_by(YEAR, SEASON, Region, date, fish_id) %>%
                dplyr::distinct() %>% # remove repeated row info
                dplyr::summarise(day_mean_surf = mean(SURFTEMP),
                                 day_mean_bot = mean(BOTTEMP)) %>% # mean by day
                dplyr::ungroup() %>%
                dplyr::group_by(YEAR, SEASON, Region) %>%
                dplyr::summarise(Mean_surface_temperature = mean(day_mean_surf) %>%
                                   round(digits = 2),
                                 Mean_bottom_temperature = mean(day_mean_bot) %>%
                                   round(digits = 2)) %>%
  character_to_factor() # mean by season-year

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", 
                       "Mean surface temperature", "Mean bottom temperature"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Salinity {.tabset .tabset-fade .tabset-pills}

Surface and bottom salinity data were pulled from ``r params$survey_source``. 

##### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, surfsalin}
if(sum(is.na(survey_data$SURFSALIN)) < length(survey_data$SURFSALIN)){
  generate_plot(survey_data,
              variable = "SURFSALIN", 
              ytitle = "Surface salinity")
} else print("NO SURFACE DATA")

if(sum(is.na(survey_data$BOTSALIN)) < length(survey_data$BOTSALIN)){
  generate_plot(survey_data,
              variable = "BOTSALIN", 
              ytitle = "Bottom salinity")
} else print("NO BOTTOM DATA")
```

##### Summary
```{r, salin_summary}
if(sum(is.na(survey_data$SURFSALIN)) < length(survey_data$SURFSALIN)){
  generate_table(survey_data,
              variable = "SURFSALIN", 
              cap = "Surface salinity")
} else print("NO SURFACE DATA")

if(sum(is.na(survey_data$BOTSALIN)) < length(survey_data$BOTSALIN)){
  generate_table(survey_data,
              variable = "BOTSALIN", 
              cap = "Bottom salinity")
} else print("NO BOTTOM DATA")
```

##### Data
```{r, salin_data}
data <- survey_data %>% 
                dplyr::select(YEAR, SEASON, Region, date, 
                              fish_id, SURFSALIN, BOTSALIN) %>%
                dplyr::filter(SURFSALIN > 0 | BOTSALIN > 0) %>%
                dplyr::group_by(YEAR, SEASON, Region, date, fish_id) %>%
                dplyr::distinct() %>% # remove repeated row info
                dplyr::summarise(day_mean_surf = mean(SURFSALIN),
                                 day_mean_bot = mean(BOTSALIN)) %>% # mean by day
                dplyr::ungroup() %>%
                dplyr::group_by(YEAR, SEASON, Region) %>%
                dplyr::summarise(Mean_surface_salinity = mean(day_mean_surf) %>%
                                   round(digits = 2),
                                 Mean_bottom_salinity = mean(day_mean_bot) %>%
                                   round(digits = 2)) %>%
  character_to_factor() # mean by season-year

DT::datatable(data, 
          rownames = FALSE,
                    colnames = c("Year", "Season", "Region", 
                       "Mean surface salinity", "Mean bottom salinity"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Abundance {.tabset .tabset-fade .tabset-pills}

Abundance data were pulled from ``r params$survey_source`` and ``r params$asmt_source``. 

##### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.

Survey abundance (raw measurements):
```{r, abun_survey}
if(sum(is.na(survey_data$ABUNDANCE)) < length(survey_data$ABUNDANCE)){
  generate_plot(survey_data,
              variable = "ABUNDANCE", 
              ytitle = "Abundance")
} else print("NO DATA")
```

Survey abundance (swept area estimates):

Please note, these estimates are not parsed by region or season. Swept area estimates are based on spring and fall surveys only. The shaded gray region indicates +/- two standard errors.
```{r, abun_survey_swept}
if(nrow(swept_data) > 0){
  plot_swept_abun(swept_data)
} else print("NO DATA")
```

Assessment abundance:
```{r, abun_asmt}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Abundance")) > 0){
plot_asmt(asmt_data, 
          metric = "Abundance", 
          ytitle = "Abundance",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

##### Survey summary
```{r, abun_summary}
if(sum(is.na(survey_data$ABUNDANCE)) < length(survey_data$ABUNDANCE)){
  generate_table(survey_data,
              variable = "ABUNDANCE", 
              cap = "Measured abundance")
} else print("NO DATA")
```

##### Data
Survey data (raw measurements):
```{r, surv_abun_data}
data <- get_var_data(survey_data, variable = "ABUNDANCE") %>%
  dplyr::mutate(variable = variable %>%
                  format(big.mark = ","))  %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", "Abundance"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Survey data (swept area estimates):
```{r, swept_abun_data}
data <- swept_data %>%
  dplyr::select(YEAR, tot.abundance, tot.abund.SE) %>%
  dplyr::mutate(YEAR = as.numeric(YEAR),
                tot.abundance = tot.abundance %>%
                  format(big.mark = ","),
                tot.abund.SE = tot.abund.SE %>%
                  round(digits = 1) %>%
                  format(big.mark = ","))

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Abundance", "Standard error"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Assessment data:
```{r, asmt_abun_data}
data <- asmt_data %>% 
                dplyr::filter(Metric == "Abundance") %>%
                dplyr::select(-Species, -Metric) %>%
                dplyr::mutate(Value = Value %>%
                              format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Biomass {.tabset .tabset-fade .tabset-pills}
Biomass data were pulled from ``r params$survey_source``. 

##### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.

Survey biomass (raw measurements):
```{r, biomass}
if(sum(is.na(survey_data$BIOMASS)) < length(survey_data$BIOMASS)){
  generate_plot(survey_data,
              variable = "BIOMASS", 
              ytitle = "Biomass")
} else print("NO DATA")
```

Survey biomass (swept area estimates):

Please note, these estimates are not parsed by region or season. Swept area estimates are based on spring and fall surveys only. The shaded gray region indicates +/- two standard errors.
```{r, bio_survey_swept}
if(nrow(swept_data) > 0){
  plot_swept_biomass(swept_data)
} else print("NO DATA")
```

Assessment biomass:
```{r, biomass_asmt}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Biomass")) > 0){
plot_asmt(asmt_data, 
          metric = "Biomass", 
          ytitle = "Biomass",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

##### Summary
```{r, biomass_summary}
if(sum(is.na(survey_data$BIOMASS)) < length(survey_data$BIOMASS)){
  generate_table(survey_data,
              variable = "BIOMASS", 
              cap = "Measured biomass")
} else print("NO DATA")
```

##### Data
Survey data (raw measurements):
```{r, biomass_data}
data <- survey_data %>% 
  dplyr::group_by(YEAR, SEASON, Region, date, fish_id) %>%
  dplyr::distinct() %>% # remove repeated row info
  dplyr::ungroup() %>%
  dplyr::group_by(YEAR, SEASON, Region) %>% # re-group
  dplyr::summarise(Biomass = sum(BIOMASS) %>%
                     format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", "Biomass"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Survey data (swept area estimates):
```{r, swept_biomass_data}
data <- swept_data %>%
  dplyr::select(YEAR, tot.biomass, tot.bio.SE) %>%
  dplyr::mutate(YEAR = as.numeric(YEAR),
                tot.biomass = tot.biomass %>%
                  format(big.mark = ","),
                tot.bio.SE = tot.bio.SE %>%
                  round(digits = 1) %>%
                  format(big.mark = ","))

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Biomass (kg)", "Standard error"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Assessment data:
```{r, asmt_biomass_data}
data <- asmt_data %>% 
                dplyr::filter(Metric == "Biomass") %>%
                dplyr::select(-Species, -Metric) %>%
                dplyr::mutate(Value = Value %>%
                              format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Catch {.tabset .tabset-fade .tabset-pills}

Stock assessment catch data are from ``r params$asmt_source``. Recreational catch data were downloaded from [NOAA MRIP](https://www.st.nmfs.noaa.gov/st1/recreational/MRIP_Estimate_Data/CSV/). Commercial catch data were downloaded from [NOAA FOSS](https://foss.nmfs.noaa.gov/apexfoss/f?p=215:200:4615327020711::NO:::).

##### Figures
Stock assessment catch:
```{r, catch}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Catch")) > 0){
plot_asmt(asmt_data, 
          metric = "Catch", 
          ytitle = "Catch",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

Recreational catch:
```{r, rec}
if(length(rec_data$Species) > 0){
  get_rec_catch(rec_data)
} else print("NO DATA")
```

Commercial catch:
```{r, com}
if(length(com_data$Species) > 0){
  plot_com(com_data)
} else print("NO DATA")
```

Commercial vs recreational catch:
```{r, comvrec}
if(length(com_data$Species) > 0 & length(rec_data$Species) > 0){
  prop_catch(com = com_data, rec = rec_data)
} else print("NO DATA")
```

##### Data
Stock assessment catch:
```{r, catch_data}
data <- asmt_data %>% 
  dplyr::filter(Metric == "Catch") %>%
  dplyr::select(-Species, -Metric) %>%
  dplyr::mutate(Value = Value %>%
                  format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Recreational catch:
```{r, rec_data}
data <- rec_data %>% 
  dplyr::select(year, st_f, mode_fx_f, tot_cat) %>%
  dplyr::mutate(State = st_f %>%
                  stringr::str_to_title(),
                Method = mode_fx_f %>% 
                  stringr::str_to_sentence(),
                Catch_pounds = tot_cat %>%
                  format(big.mark = ",")) %>%
  dplyr::select(year, State, Method, Catch_pounds) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "State", "Method", "Catch (lb)"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Commercial catch:
```{r, com_data}
data <- com_data %>% 
                dplyr::select(Year, State, Dollars_adj, Pounds) %>%
                dplyr::mutate(Dollars_adj = Dollars_adj %>% 
                                round(digits = 0) %>%
                                format(big.mark = ","),
                              State = State %>% 
                                stringr::str_to_title(),
                              Pounds = Pounds %>%
                                format(big.mark = ",")) %>%
                dplyr::rename("Revenue (2019 dollars)" = "Dollars_adj",
                              "Commercial catch (lb)" = "Pounds") %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Commercial vs recreational catch:
```{r, comvrec_data}
data <- prop_catch_data(rec = rec_data, com = com_data) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Recreational catch", "Commercial catch",
                       "Total catch", "Proportion recreational",
                       "Proportion commercial"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Length {.tabset .tabset-fade .tabset-pills}
Length data were pulled from ``r params$survey_source``. Only years with more than 10 fish lengths were considered for analysis. 

##### Figures

Separate geom_gls() functions were fit for the minimum, mean, and maximum lengths; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than three trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, length}
if(sum(is.na(survey_data$LENGTH)) < length(survey_data$LENGTH)){
  generate_len_plot(survey_data)
} else print("NO DATA")
```

##### Summary
```{r, length_summary}
if(sum(is.na(survey_data$LENGTH)) < length(survey_data$LENGTH)){
  generate_len_table(survey_data)
} else print("NO DATA")
```

##### Data
```{r, length_data}
data <- get_len_data2(survey_data) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", "Number of fish",
                       "Mean length", "Minimum length", "Maximum length"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Condition {.tabset .tabset-fade .tabset-pills}
Condition information comes from [diet data](https://github.com/Laurels1/Condition/blob/master/data/allfh.RData); only regions and seasons with more than 10 fish observations were considered. We calculated a rough condition factor as: Weight / Length^3, and relative weight was [previously calculated](https://github.com/Laurels1/Condition/tree/master/data).

##### Figures

Length vs weight

Please note, no trend lines were fit, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, lw}
if(length(diet_data$Species) >= 1){
plot_lw(diet_data)
} else print("NO DATA")
```

Condition factor: Weight-volume

If there were more than 30 years of data, a geom_gls() regression was fit. In order to fit the geom_gls() regression, we calculated the mean condition factor for each year and plotted the geom_gls() through those points. Please note, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, condition}
if(length(diet_data$Species) >= 1){
plot_cond(diet_data)
} else print("NO DATA")
```

Condition factor: Relative weight

Please note, this data is aggregated by Ecological Protection Unit (EPU), which may differ slightly from the stock assessment regions.
```{r, laurel_cond}
if(length(cond_data$Species) >= 1){
plot_relw(cond_data)
} else print("NO DATA")
```

##### Data

Length vs weight with weight-volume condition factor
```{r, lw_data}
data <- diet_data %>%
  dplyr::filter(is.na(pdlen) == FALSE, 
                  is.na(pdwgt) == FALSE) %>%
  dplyr::select(pdlen, pdwgt, season, Region, fish_id, year) %>%
  dplyr::distinct() %>% # remove duplicates
  dplyr::group_by(Region, season) %>%
  dplyr::mutate(n_fish = length(pdlen)) %>%
  dplyr::filter(n_fish > 10) %>% # only region-season with >10 fish)
  dplyr::mutate(condition = pdwgt/(pdlen^3)) %>%
  dplyr::mutate(condition = condition %>%
                  round(digits = 4)) %>%
  dplyr::select(Region, year, season, pdlen, pdwgt, condition) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Region", "Year", "Season", "Fish length (cm)", 
                       "Fish weight (g)", "Condition (g/cm^3)"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

Relative weight condition factor
Please note, this data is aggregated by Ecological Protection Unit (EPU), which may differ slightly from the stock assessment regions.
```{r, laurel_cond_data}
data <- cond_data %>%
  dplyr::select(-Species, -n) %>%
  dplyr::mutate(MeanCond = MeanCond %>%
                  round(digits = 1)) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("EPU", "Fish sex", "Year", "Mean condition",
                       "Number of fish"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

### Risk analysis
A preliminary risk analysis was conducted by ranking all species according to their indicator values. A high rank number and a normalized rank near 1 indicates that the species is at risk or of importance based on the measured indicator values. When a species was missing an indicator, it was assigned a normalized rank of 0.5.
```{r, risk}
data <- risk_data %>% dplyr::mutate(Rank = paste(rank, "out of", n_stocks_per_indicator),
                       Value2 = Value %>% 
                         format(big.mark = ",", scientific = FALSE, digits = 2),
                       Normalized_rank = norm_rank %>% round(digits = 2)) %>%
  dplyr::select(Region, category, Indicator, Year, Value2, Rank, Normalized_rank) %>%
  dplyr::rename("Value" = "Value2") %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Region", "Category", "Indicator", "Year", "Value",
                       "Rank", "Normalized rank"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```