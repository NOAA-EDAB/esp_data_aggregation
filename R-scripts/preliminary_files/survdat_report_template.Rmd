---
title: "survdat_testing"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: html_document
params: 
  species_ID: "000"
  data_source: data
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'center')
```

```{r, functions, include = FALSE}
library(ggplot2)

`%>%` <- dplyr::`%>%`

get_var_data <- function(x, variable){
  y <- dplyr::filter(x, get(variable) > 0, ABUNDANCE > 0)
  
# mean by year
if(variable == "BIOMASS" | variable == "ABUNDANCE"){
     y <- y %>% dplyr::group_by(YEAR, SEASON) %>%
     dplyr::summarise(variable2 = sum(get(variable)))
  } else {
    y <- y %>% dplyr::group_by(YEAR, SEASON) %>%
    dplyr::summarise(variable2 = mean(get(variable)))
  }

colnames(y) <- c("YEAR", "SEASON", "variable")

return(y)
}

plot_variable <- function(x, season, ytitle) {

  y <- filter(x, SEASON == season)
  
  # use geom_gls only if there are 30 or more years of data
  if(length(y$YEAR) >= 30){
    fig <- ggplot(y,
         aes(x = as.numeric(YEAR),
             y = variable))+
    geom_point()+
    ecodata::geom_gls()+
    theme_bw()+
    xlab("Year")+
    ylab(ytitle)+
    labs(title = season)
  } else {
    fig <- ggplot(y,
         aes(x = as.numeric(YEAR),
             y = variable))+
    geom_point()+
    theme_bw()+
    xlab("Year")+
    ylab(ytitle)+
    labs(title = season)
  }

  return(fig)
}

format_numbers <- function(x) {as.numeric(as.character(unlist(x)))}

data_summary <- function(x, season) {

  season_data <- dplyr::filter(x, SEASON == season)

  year_data <- format_numbers(season_data$YEAR)

  variable_data <- format_numbers(season_data[,3])

  all_data <- c(paste(min(year_data), max(year_data), sep = " - "),
                length(year_data),
                round(mean(variable_data, na.rm = TRUE), digits = 2),
                round(sd(variable_data, na.rm = TRUE), digits = 2),
                round(min(variable_data, na.rm = TRUE), digits = 2),
                round(max(variable_data, na.rm = TRUE), digits = 2))
  
  z <- filter(season_data, YEAR > (max(year_data) - 5))

  five_year_data <- format_numbers(z$YEAR)
  five_variable_data <- format_numbers(z[,3])
  
  five_data <- c(paste(min(five_year_data), max(five_year_data), sep = " - "),
                 length(five_year_data),
                 round(mean(five_variable_data, na.rm = TRUE), digits = 2),
                 round(sd(five_variable_data, na.rm = TRUE), digits = 2),
                 round(min(five_variable_data, na.rm = TRUE), digits = 2),
                 round(max(five_variable_data, na.rm = TRUE), digits = 2))
  
  output <- rbind(c(season, all_data), c(season, five_data))
  
  return(output)
}

generate_info <- function(x, ytitle, variable){
  
  data <- get_var_data(x, variable = variable)
  
  spring_fig <- plot_variable(data, 
              season = "SPRING",
              ytitle = ytitle)
  
 fall_fig <- plot_variable(data, 
              season = "FALL",
              ytitle = ytitle)

  table <- rbind(data_summary(data, season = "SPRING"),
                 data_summary(data, season = "FALL"))
                 
  colnames(table) <- c("SEASON", "YEARS", "N_YEARS", "MEAN", "SD", "MIN", "MAX")
  
  print(spring_fig)
  print(fall_fig)
  return(knitr::kable(table))
}
```

```{r, data, include = FALSE}
species <- params$species_ID
data <- params$data_source
plot_data <- data[data$SVSPP == species,]

# TO-DO
## x write if() loop so stat_smooth only runs on data sets with enough data
## get geom_gls() to work
## find average from past 5 years and compare to long-term average?
## or some other comparison metric
```

## Test of Survdat data, species SVSPP `r species`

This is a test report of `survdat` data. 

This report is pulling information on the species with the SVSPP ID: `r species`.
Years with zero abundance were not included in this analysis. Abundance and biomass were summed for each year and season. All other metrics were averaged for each year and season. Each metric was then plotted against time. If there were 30 or more years of data, a geom_gls regression line was fit (yellow = significant increase; purple = significant decrease; no line = no significant trend). If there were fewer than 30 years of data, no regression was fit. The tables show summary statistics for the entire time series and for the most recent 5 years in the time series. 

### Temperature

#### Surface temperature
```{r, surftemp}
generate_info(plot_data,
              variable = "SURFTEMP", 
              ytitle = "Surface temperature")
```

#### Bottom temperature
```{r, bottemp}
generate_info(plot_data,
              variable = "BOTTEMP", 
              ytitle = "Bottom temperature")
```

### Salinity 

#### Surface salinity
```{r, surfsalin}
generate_info(plot_data,
              variable = "SURFSALIN", 
              ytitle = "Surface salinity")
```

#### Bottom salinity
```{r, botsalin}
generate_info(plot_data,
              variable = "BOTSALIN", 
              ytitle = "Bottom salinity")
```

### Abundance
```{r, abundance}
generate_info(plot_data,
              variable = "ABUNDANCE", 
              ytitle = "Abundance")
```

### Biomass
```{r, biomass}
generate_info(plot_data,
              variable = "BIOMASS", 
              ytitle = "Biomass")
```

### Length
```{r, length}
generate_info(plot_data,
              variable = "LENGTH", 
              ytitle = "Length")
```

