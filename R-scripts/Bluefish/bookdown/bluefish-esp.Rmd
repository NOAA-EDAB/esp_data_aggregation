---
title: "Preliminary Bluefish ESP"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    split_by: section
documentclass: book
github-repo: NOAA-EDAB/esp_data_aggregation
params:
  lag: 0 # lag for correlations
  remove_recent: FALSE
  cache: FALSE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE, 
                      cache = params$cache,
                      results = "asis",
                      fig.width = 8, 
                      fig.align = 'center')

library(ggplot2)
`%>%` <- dplyr::`%>%`

source(here::here("R/Bluefish", "indicator_functions.R"))

bluefish <- assessmentdata::stockAssessmentData %>% 
  dplyr::filter(Species == "Bluefish", 
                AssessmentYear == 2019) %>%
  dplyr::rename(Time = Year)

if(params$remove_recent){
  max_year <- max(bluefish$Time)
  bluefish <- bluefish %>%
    dplyr::filter(Time <= (max_year - 10))
} 

output <- c()

```

# Introduction

These are preliminary regressions that compare bluefish catch, abundance, recruitment, and F to various indicators taken from the `ecodata` package. The indicators are lagged by `r params$lag` years.

# Regression analysis

All regressions are simple linear correlations assessed at the p < 0.5 level. Please note, due to the large number of indicators tested, a certain amount of statistically significant results are expected even if there are no underlying mechanistic connections. These correlations do not necessarily imply causation.

<!--chapter:end:index.Rmd-->

## Trends with time
```{r, time}
test <- bluefish %>%
  dplyr::mutate(Val = Time,
                Var = "Time") %>%
  dplyr::select(Time, Val, Var)
render_indicator(test)
```

<!--chapter:end:01-time-trends.Rmd-->

## Physical indicators

### Cold pool index
```{r, cold_pool}
test <- ecodata::cold_pool
render_indicator(test)
```

### Warm core rings
```{r, warm}
test <- ecodata::wcr %>%
  dplyr::rename(Val = Value) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Marine heatwave index
```{r, heatwave}
test <- ecodata::heatwave %>%
  dplyr::rename(Val = Value) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### GLORYS bottom temperature
```{r, glorys}
test <- ecodata::bottom_temp_glorys %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Long-term sea surface temperature
```{r, sst}
test <- ecodata::long_term_sst  %>%
  dplyr::rename(Val = Value) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Sea surface temperature anomaly
```{r, sst_anom}
test <- ecodata::seasonal_oisst_anom %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Spring offshore bottom temperature
Bluefish are typically found offshore in the spring.

### Fall onshore bottom temperature
Bluefish are typically found onshore in the fall.

### Stratification
```{r, strat}
test <- ecodata::stratification %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Winter wind speed
```{r, winter_wind}
test <- ecodata::ne_wind %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB",
                Var %>% stringr::str_detect("winter")) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Spring wind speed
```{r, spring_wind}
test <- ecodata::ne_wind %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB",
                Var %>% stringr::str_detect("spring")) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Summer wind speed
```{r, summer_wind}
test <- ecodata::ne_wind %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB",
                Var %>% stringr::str_detect("summer")) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Fall wind speed
```{r, fall_wind}
test <- ecodata::ne_wind %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB",
                Var %>% stringr::str_detect("fall")) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Gulf Stream Index
```{r, gsi}
test <- ecodata::gsi %>%
  dplyr::rename(Val = Value) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"),
                Time = Time %>%
                  stringr::str_trunc(width = 4, ellipsis = "") %>%
                  as.numeric())
render_indicator(test)
```

### North Atlantic Oscillation
```{r, nao}
test <- ecodata::nao %>%
  dplyr::rename(Val = Value) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Chlorophyll
```{r, chl}
test <- ecodata::chl_pp %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = Var %>%
                  stringr::str_replace_all("_", "\n") %>%
                  stringr::str_replace_all(" ", "\n")) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

<!--chapter:end:02-physical-indicators.Rmd-->

## Trophic indicators

### Spring zooplankton abundance by species
```{r, zoo_oi_spring}
test <- ecodata::zoo_oi %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB",
                Var %>% stringr::str_detect("SD") == FALSE,
                Var %>% stringr::str_detect("spring")) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Fall zooplankton abundance by species
```{r, zoo_oi_fall}
test <- ecodata::zoo_oi %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB",
                Var %>% stringr::str_detect("SD") == FALSE,
                Var %>% stringr::str_detect("fall")) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Zooplankton abundance by group
```{r, zoo_strat_abun}
test <- ecodata::zoo_strat_abun %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Abundance of Calanus CV and adults
```{r, calanus}
test <- ecodata::CalanusStage %>%
  dplyr::rename(Time = Year) %>%
  dplyr::filter(Var == "Adt" | Var == "CV",
                EPU == "MAB",
                Units == "No. per 100m^-3") %>%
  dplyr::group_by(Time) %>%
  dplyr::mutate(Val = sum(Value)) %>%
  dplyr::select(Time, Val) %>% # numbers are the same for all seasons in a year
  dplyr::distinct() %>%
  dplyr::mutate(Var = "Calanus CV and adult")
render_indicator(test)
```

### Zooplankton abundance anomaly
```{r, zoo_abund}
test <- ecodata::zoo_abund %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Zooplankton diversity index
```{r, zoo_diversity}
test <- ecodata::zoo_diversity %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Small/large copepod anomaly
```{r, zoo_sli_anom}
test <- ecodata::zoo_sli_anom %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(EPU == "MAB") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Spring ichthyoplankton diversity
```{r, forage_spring}
test <- ecodata::ichthyo_diversity  %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(Season == "Spring") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Fall ichthyoplankton diversity
```{r, forage_fall}
test <- ecodata::ichthyo_diversity  %>%
  dplyr::rename(Val = Value) %>%
  dplyr::filter(Season == "Fall") %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Forage fish abundance
```{r, forage}
test <- ecodata::forage_anomaly %>%
  dplyr::rename(Val = Value)
render_indicator(test)
```

### Species distribution
```{r, species_dist}
test <- ecodata::species_dist %>%
  dplyr::rename(Val = Value) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

<!--chapter:end:03-trophic-indicators.Rmd-->

## Larvae and YOY indicators

### Recruitment
```{r, recruit}
test <- bluefish %>%
  dplyr::filter(Metric == "Recruitment") %>%
  dplyr::rename(Var = Metric,
                Val = Value)
render_indicator(test)
```

### Larval growth

<!--chapter:end:04-larvae-YOY.Rmd-->

## Juvenile indicators

### Length-age curves

### Condition

### CPUE

<!--chapter:end:05-juvenile.Rmd-->

## Adult indicators

### Size of spawning stock
```{r, ssb}
test <- bluefish %>%
  dplyr::filter(Metric == "Abundance") %>%
  dplyr::rename(Var = Metric,
                Val = Value)
render_indicator(test)
```

### Mean age of spawning stock

### Age distribution

### Length-age curves

### Condition
```{r, condition}
test <- read.csv("https://raw.githubusercontent.com/Laurels1/Condition/master/data/AnnualRelCond2018_MAB.csv") %>%
  dplyr::filter(Species == "Bluefish") %>%
  dplyr::rename(Val = MeanCond,
                Time = YEAR) %>%
  dplyr::mutate(Var = paste(sex, "condition"))
render_indicator(test)
```

### Stomach fullness
```{r, stomach}
test <- ecodata::stom_fullness %>% 
  dplyr::filter(Var == "Bluefish",
                EPU == "MAB") %>%
  dplyr::rename(Val = Value) %>%
  dplyr::mutate(Var = paste(Var, Units, sep = "\n"))
render_indicator(test)
```

### Center of gravity and area occupied

<!--chapter:end:06-adult.Rmd-->

## Socioeconomic indicators

### CPUE by catch strategy

### Recreational CPUE
```{r, rec_cpue}
numbers <- ecodata::recdat %>%
  dplyr::filter(Var == "Recreational Seafood",
                EPU == "NE") %>%
  dplyr::rename(Number = Value)

days <- ecodata::recdat %>%
  dplyr::filter(Var == "Recreational Effort",
                EPU == "NE") %>%
  dplyr::rename(Days = Value)

test <- dplyr::left_join(numbers, days, by = "Time") %>%
  dplyr::mutate(Val = Number/Days,
                Var = paste("recreational CPUE", "number of fish caught per day fished", sep = "\n"))
render_indicator(test)
```

<!--chapter:end:07-socioeconomic.Rmd-->

# Summary of statistically significant indicators

```{r, output_summary}
source(here::here("R/full_report_functions", "make_html_table.R"))

summary_table <- function(x){
    DT::datatable(x,
                  rownames = FALSE,
                  filter = list(position = 'top', 
                                clear = FALSE),
                  options = list(search = list(regex = TRUE),
                                 paging = FALSE))
}

colnames(output) <- c("Response_variable", "Indicator", 
                                 "Number of data points", "Slope", 
                                 "P-value", "R2_adj")
```

## Abundance
```{r, eval = TRUE}
output %>% 
  tibble::as_tibble() %>%
  dplyr::filter(Response_variable == "Abundance",
                R2_adj < 1) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()


```

## Recruitment
```{r, eval = TRUE}
output %>% 
  tibble::as_tibble() %>%
  dplyr::filter(Response_variable == "Recruitment",
                R2_adj != 1) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()

```

## Catch
```{r, eval = TRUE}
output %>% 
  tibble::as_tibble() %>%
  dplyr::filter(Response_variable == "Catch",
                R2_adj != 1) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()

```

## Fmort
```{r, eval = TRUE}
output %>% 
  tibble::as_tibble() %>%
  dplyr::filter(Response_variable == "Fmort",
                R2_adj != 1) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()

```


<!--chapter:end:08-summary.Rmd-->

