---
title: "ESP data widgets"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: html_document
github-repo: NOAA-EDAB/esp_data_aggregation
---

```{r, eval = FALSE, include = FALSE}
rmarkdown::render(input = here::here("R", "data_visualization.Rmd"),
                  output_dir = here::here("docs"))
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE #, 
                      #warning = FALSE
                      )

`%>%` <- dplyr::`%>%`

source(here::here("R/full_report_functions", "read_data.R"))
source(here::here("R", "character_to_factor.R"))
source(here::here("R/full_report_functions", "make_html_table.R"))
```

This document provides interactive html tables for all data sources used in the preliminary Northeast ESP reports. Data is presented as raw as possible, with column names updated for easier interpretation. In some cases, summary columns have been appended (most commonly to add a region name in addition to a strata ID number). In cases where data is categorized by descriptors beyond year and stock region (for example, also aggregated by state), a summary table is presented with the data aggregated by year and stock region only; this highlights annual trends.

# {- .tabset .tabset-fade}

## Survey data {.tabset .tabset-fade .tabset-pills}

This data was pulled from `svdbs` using the `survdat` package.

### Raw data {- .tabset .tabset-fade}
Duplicates removed.

#### Temperature
```{r, temp, eval = FALSE}
data <- survey %>%
  dplyr::filter(is.na(SURFTEMP) == FALSE |
                  is.na(BOTTEMP) == FALSE) %>%
  dplyr::select(Species, Region, YEAR, SEASON, EST_TOWDATE, CRUISE6, STATION, 
                STRATUM, DEPTH, SURFTEMP, BOTTEMP) %>%
  dplyr::distinct() %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

#### Salinity
```{r, salin, eval = FALSE}
data <- survey %>%
  dplyr::filter(is.na(SURFSALIN) == FALSE |
                  is.na(BOTSALIN) == FALSE) %>%
  dplyr::select(Species, Region, YEAR, SEASON, EST_TOWDATE, CRUISE6, STATION, 
                STRATUM, DEPTH, SURFSALIN, BOTSALIN) %>%
  dplyr::distinct() %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

#### Length
```{r, length, eval = FALSE}
data <- survey %>%
  dplyr::filter(is.na(SURFSALIN) == FALSE |
                  is.na(BOTSALIN) == FALSE) %>%
  dplyr::select(Species, Region, YEAR, SEASON, EST_TOWDATE, CRUISE6, STATION, 
                STRATUM, DEPTH, LENGTH, NUMLEN) %>%
  dplyr::distinct() %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

#### Abundance
```{r, abun, eval = FALSE}
data <- survey %>%
  dplyr::filter(is.na(SURFSALIN) == FALSE |
                  is.na(BOTSALIN) == FALSE) %>%
  dplyr::select(Species, Region, YEAR, SEASON, EST_TOWDATE, CRUISE6, STATION, 
                STRATUM, DEPTH, ABUNDANCE) %>%
  dplyr::distinct() %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

#### Biomass
```{r, biomass, eval = FALSE}
data <- survey %>%
  dplyr::filter(is.na(SURFSALIN) == FALSE |
                  is.na(BOTSALIN) == FALSE) %>%
  dplyr::select(Species, Region, YEAR, SEASON, EST_TOWDATE, CRUISE6, STATION, 
                STRATUM, DEPTH, BIOMASS) %>%
  dplyr::distinct() %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

### Aggregated data {-}
Aggregated by `fish_id`.
```{r, coming_soon}
print("Coming soon!")
```

### Processed data {-}
Mean values calculated by year and region; minimum and maximum lengths also included.
```{r, ref.label = "coming_soon"}
```

## Stock assessment summary data {.tabset .tabset-fade .tabset-pills}

### Raw data {-}
```{r}
data <- asmt_sum %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

## Stock assessment full data {.tabset .tabset-fade .tabset-pills}

### Raw data {- .tabset .tabset-fade}

#### Catch
```{r}
data <- asmt %>%
  dplyr::select(-Age, -Category) %>%
  dplyr::filter(Metric == "Catch") %>%
  dplyr::filter(is.na(Value) == FALSE) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

#### Biomass
```{r}
data <- asmt %>%
  dplyr::select(-Age, -Category) %>%
  dplyr::filter(Metric == "Biomass") %>%
  dplyr::filter(is.na(Value) == FALSE) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

#### Abundance
```{r}
data <- asmt %>%
  dplyr::select(-Age, -Category) %>%
  dplyr::filter(Metric == "Abundance") %>%
  dplyr::filter(is.na(Value) == FALSE) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

#### Recruitment
```{r}
data <- asmt %>%
  dplyr::select(-Age, -Category) %>%
  dplyr::filter(Metric == "Recruitment") %>%
  dplyr::filter(is.na(Value) == FALSE) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

## Recreational catch {.tabset .tabset-fade .tabset-pills}

### Raw data {-}
```{r}
data <- rec %>%
  dplyr::select(Species, year, sub_reg_f, st_f, mode_fx_f, lbs_ab1) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

### Aggregated by fishing mode {-}
```{r}
data <- rec %>%
  dplyr::select(Species, year, sub_reg_f, st_f, mode_fx_f, lbs_ab1) %>%
  dplyr::group_by(Species, year, mode_fx_f) %>%
  dplyr::summarise(catch = sum(lbs_ab1)) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

### Aggregated by year only {-}
```{r}
data <- rec %>%
  dplyr::select(Species, year, sub_reg_f, st_f, mode_fx_f, lbs_ab1) %>%
  dplyr::group_by(Species, year) %>%
  dplyr::summarise(catch = sum(lbs_ab1)) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```


