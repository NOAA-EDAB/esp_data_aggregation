## Trophic indicators


### Chlorophyll
```{r, chl}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_replace_all("_", "\n") %>%
    stringr::str_replace_all(" ", "\n")) %>%
  dplyr::filter(stringr::str_detect(Var, "ANNUAL")) %>% # only annual indices
  dplyr::mutate(Time = Time %>%
    stringr::str_replace("A_", "") %>%
    as.numeric())
NEesp::render_indicator(test, lab = names[1])

# data_prep(stock, test, lag = params$lag) %>% knitr::kable()
```

### Chlorophyll in stock region
```{r, chl-stock}
test <- ecodata::ESP_seasonal_chl %>%
  dplyr::mutate(Pattern_check = ESP %>%
    stringr::str_replace_all("_", " ") %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(stringr::str_detect(Pattern_check, params$stock)) %>%
  dplyr::distinct()

if (nrow(test) > 0) {
  if (length(unique(test$Pattern_check)) > 1) {
    # add stock region into var for faceting
    test <- test %>%
      dplyr::mutate(Var = paste(Var, Pattern_check, sep = " ") %>%
        stringr::str_replace_all("_", "") %>%
        stringr::str_wrap(width = 8))
    NEesp::render_indicator(test, lab = names[1])
  } else {
    test <- test %>%
      dplyr::mutate(Var = paste0(Var, "_stock"))

    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "Indicator data has not been parsed over this stock's region"
}
```

### Primary production in stock region
```{r, pp-stock}
test <- ecodata::ESP_seasonal_pp %>%
  dplyr::mutate(Pattern_check = ESP %>%
    stringr::str_replace_all("_", " ") %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(stringr::str_detect(Pattern_check, params$stock)) %>%
  dplyr::distinct()

if (nrow(test) > 0) {
  if (length(unique(test$Pattern_check)) > 1) {
    # add stock region into var for faceting
    test <- test %>%
      dplyr::mutate(Var = paste(Var, Pattern_check, sep = " ") %>%
        stringr::str_replace_all("_", "") %>%
        stringr::str_wrap(width = 8))
    NEesp::render_indicator(test, lab = names[1])
  } else {
    test <- test %>%
      dplyr::mutate(Var = paste0(Var, "_stock"))

    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "Indicator data has not been parsed over this stock's region"
}
```

### Spring zooplankton abundance by species
```{r, zoo-oi-spring}
test <- ecodata::zoo_oi %>%
  dplyr::filter(
    Var %>% stringr::str_detect("SD") == FALSE,
    Var %>% stringr::str_detect("spring")
  )
NEesp::render_indicator(test, lab = names[1])
```

### Fall zooplankton abundance by species
```{r, zoo-oi-fall}
test <- ecodata::zoo_oi %>%
  dplyr::filter(
    Var %>% stringr::str_detect("SD") == FALSE,
    Var %>% stringr::str_detect("fall")
  )
NEesp::render_indicator(test, lab = names[1])
```

### Zooplankton abundance by group
```{r, zoo-strat-abun}
test <- ecodata::zoo_strat_abun
NEesp::render_indicator(test, lab = names[1])
```

### Abundance of Calanus CV and adults
```{r, calanus}
test <- ecodata::calanus_stage %>%
  dplyr::rename(Time = Year) %>%
  dplyr::filter(
    Var == "adt" | Var == "c5",
    Units == "No. per 100m^-3"
  ) %>%
  dplyr::group_by(Time, EPU, season) %>%
  dplyr::mutate(Val = sum(Value)) %>%
  dplyr::select(Time, Val, EPU, season) %>%
  dplyr::distinct() %>%
  dplyr::mutate(Var = paste("Calanus CV and adult", season))
NEesp::render_indicator(test, lab = names[1])
```

### Zooplankton abundance anomaly
```{r, zoo-abund}
test <- ecodata::zoo_abund
NEesp::render_indicator(test, lab = names[1])
```

### Annual zooplankton abundance in the stock region
```{r, zoop-stock-annual}
if (params$stock == "Black sea bass") {
  # load data
  load(here::here("data", "Annual_Black_Seabass_zooplankton_anomalies.rda"))
  test_big <- bsb.spr.anom
  colnames(test_big) <- paste(colnames(test_big), "_annual", sep = "")

  # update names for saving figs
  names <- c(colnames(test_big), names[-1])

  # loop child doc
  for (i in 1:ncol(test_big)) {
    test <- tibble::tibble(
      Time = rownames(test_big),
      Var = colnames(test_big)[i],
      Val = test_big[, i]
    )
    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "No data for this species yet"
}
```

### Spring zooplankton abundance in the stock region
```{r, zoop-stock-spring}
if (params$stock == "Black sea bass") {
  # load data
  load(here::here("data", "Spring_Black_Seabass_zooplankton_anomalies.rda"))
  test_big <- bsb.spr.anom
  colnames(test_big) <- paste(colnames(test_big), "_spring", sep = "")

  # update names for saving figs
  names <- c(colnames(test_big), names[-1])

  # loop child doc
  for (i in 1:ncol(test_big)) {
    test <- tibble::tibble(
      Time = rownames(test_big),
      Var = colnames(test_big)[i],
      Val = test_big[, i]
    )

    # make section title (not sure why this isn't printing)
    cat(paste("####", names[1]), "\n\n")

    # render section
    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "No data for this species yet"
}
```

### Fall zooplankton abundance in the stock region
```{r, zoop-stock-fall}
if (params$stock == "Black sea bass") {
  # load data
  load(here::here("data", "Fall_Black_Seabass_zooplankton_anomalies.rda"))
  test_big <- bsb.spr.anom
  colnames(test_big) <- paste(colnames(test_big), "_fall", sep = "")

  # update names for saving figs
  names <- c(colnames(test_big), names[-1])

  # loop child doc
  for (i in 1:ncol(test_big)) {
    test <- tibble::tibble(
      Time = rownames(test_big),
      Var = colnames(test_big)[i],
      Val = test_big[, i]
    )
    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "No data for this species yet"
}
```

### Zooplankton diversity index
```{r, zoo-diversity}
test <- ecodata::zoo_diversity
NEesp::render_indicator(test, lab = names[1])
```

### Small/large copepod anomaly
```{r, zoo-sli-anom}
test <- ecodata::zoo_sli_anom
NEesp::render_indicator(test, lab = names[1])
```

### Ichthyoplankton diversity
```{r, ich}
test <- ecodata::ichthyo_diversity
NEesp::render_indicator(test, lab = names[1])
```

### Forage fish abundance
```{r, forage}
test <- ecodata::forage_anomaly
NEesp::render_indicator(test, lab = names[1])
```

### Species distribution
```{r, species-dist}
test <- ecodata::species_dist
NEesp::render_indicator(test, lab = names[1])
```
