---
title: "Black sea bass indicator analysis"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: word_document
---

```{r, setup, include = FALSE}
# set width & height
n <- 6.5 

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.height = n,
  fig.width = n,
  dpi = 200 # not sure why default 72 dpi looks worse in word output compared to saved figs
)

`%>%` <- magrittr::`%>%`
dir.create("figures")

plot_corr_only <- function(data, title = "") {
  if (nrow(data) > 0) {
    my_colors <- c("black", "#B2292E")
    names(my_colors) <- c("FALSE", "TRUE")

    data$sig <- factor(data$sig, levels = c("TRUE", "FALSE"))

    fig <- ggplot2::ggplot(data, ggplot2::aes(
      x = Val,
      y = Value
    )) +
      ggplot2::geom_path(ggplot2::aes(color = Time)) +
      ggplot2::geom_point(ggplot2::aes(color = Time)) +
      ggplot2::scale_color_gradient(
        low = "#7F7FFF",
        high = "#575195", breaks = seq(1950, 2020,
          by = 10
        ),
        name = "Year",
        guide = ggplot2::guide_colorbar(order = 2)
      ) +
      ggnewscale::new_scale_color() +
      ggplot2::stat_smooth(ggplot2::aes(color = sig),
        method = "lm"
      ) +
      ggplot2::scale_color_manual(
        values = my_colors,
        name = "Statistically significant\n(p < 0.05)",
        drop = FALSE,
        guide = ggplot2::guide_legend(order = 1)
      ) +
      ggplot2::scale_y_continuous(labels = scales::comma) +
      ggplot2::scale_x_continuous(labels = scales::comma) +
      ggplot2::theme_bw() +
      ggplot2::labs(title = "Correlation between black sea bass and indicator") +
      ggplot2::ylab(unique(data$Metric)) +
      ggplot2::xlab(unique(data$Var))

    # test if bsb is sig over time - overwrite sig
    dat <- data %>%
      dplyr::select(Value, Time) %>%
      dplyr::distinct()
    model <- lm(Value ~ Time, data = dat)
    pval <- summary(model)$coefficients[2, 4]
    data$sig <- (pval < 0.05)

    bsb_fig <- ggplot2::ggplot(
      data,
      ggplot2::aes(
        x = Time,
        y = Value
      )
    ) +
      ggplot2::geom_path(ggplot2::aes(color = Time)) +
      ggplot2::geom_point(ggplot2::aes(color = Time)) +
      ggplot2::scale_color_gradient(
        low = "#7F7FFF",
        high = "#575195",
        breaks = seq(1950, 2020,
          by = 10
        ),
        name = "Year"
      ) +
      ggnewscale::new_scale_color() +
      ggplot2::stat_smooth(ggplot2::aes(color = sig),
        method = "lm"
      ) +
      ggplot2::scale_color_manual(
        values = my_colors,
        name = "Statistically significant\n(p < 0.05)"
      ) +
      ggplot2::scale_y_continuous(labels = scales::comma) +
      ggplot2::theme_bw() +
      ggplot2::labs(title = "Black sea bass over time") +
      ggplot2::xlab("Year") +
      ggplot2::ylab(unique(data$Metric))

    # test if indicator is sig over time - overwrite sig
    dat <- data %>%
      dplyr::select(Val, Time) %>%
      dplyr::distinct()
    model <- lm(Val ~ Time, data = dat)
    pval <- summary(model)$coefficients[2, 4]
    data$sig <- (pval < 0.05)

    ind_fig <- ggplot2::ggplot(
      data,
      ggplot2::aes(
        x = Time,
        y = Val
      )
    ) +
      ggplot2::geom_path(ggplot2::aes(color = Time)) +
      ggplot2::geom_point(ggplot2::aes(color = Time)) +
      ggplot2::scale_color_gradient(
        low = "#7F7FFF",
        high = "#575195", breaks = seq(1950, 2020,
          by = 10
        ),
        name = "Year"
      ) +
      ggnewscale::new_scale_color() +
      ggplot2::stat_smooth(ggplot2::aes(color = sig),
        method = "lm"
      ) +
      ggplot2::scale_color_manual(
        values = my_colors,
        name = "Statistically significant\n(p < 0.05)"
      ) +
      ggplot2::scale_y_continuous(labels = scales::comma) +
      ggplot2::theme_bw() +
      ggplot2::labs(title = "Indicator over time") +
      ggplot2::xlab("Year") +
      ggplot2::ylab(unique(data$Var))

    big_fig <- ggpubr::ggarrange(
      ggpubr::ggarrange(bsb_fig, ind_fig,
        ncol = 2,
        legend = "none",
        labels = c("A", "B")
      ),
    fig,
    common.legend = TRUE,
    legend = "top",
    nrow = 2,
    labels = c(NA, "C")
    ) +
      ggplot2::theme(
        plot.background = ggplot2::element_rect(color = "black", size = 1),
        plot.margin = ggplot2::unit(c(0.1, 0.1, 0.1, 0.1), "cm")
      )

    ggpubr::annotate_figure(big_fig, top = title)

    ggplot2::ggsave(
      filename = paste("figures/",
        unique(data$Var) %>%
          stringr::str_replace_all(" ", "_") %>%
          stringr::str_replace_all("\n", "_"),
        ".png",
        sep = ""
      ),
      width = 6.5,
      height = 6.5,
      units = "in",
      device = "png"
    )
    return(big_fig)
  }
  else {
    print("No data under conditions selected")
  }
}

prep_data <- function(data, metric = "Recruitment") {
  data <- data %>%
    read.csv() %>%
    dplyr::filter(
      Metric == metric,
      stringr::str_detect(Var, "north", negate = TRUE),
      stringr::str_detect(Var, "south", negate = TRUE)
    ) %>%
    dplyr::mutate(Var = Var %>%
      stringr::str_replace_all("\n", " ") %>%
      stringr::str_wrap(40))

  return(data)
}
```

## Recruitment 

### Winter SST anomaly
```{r, winter-sst}
here::here(
  "black-sea-bass", "Black sea bass_regression_report_0lag", "data",
  "Black_sea_bass_Mid_MAB_0_lag_FALSE_remove_recent_sst-anom-stock.csv"
) %>%
  prep_data() %>%
  dplyr::filter(stringr::str_detect(Var, "winter")) %>%
  plot_corr_only()
```

### Fall SST anomaly (prior year)
```{r, fall-sst}
here::here(
  "black-sea-bass", "Black sea bass_regression_report_1lag", "data",
  "Black_sea_bass_Mid_MAB_1_lag_FALSE_remove_recent_sst-anom-stock.csv"
) %>%
  prep_data() %>%
  dplyr::filter(stringr::str_detect(Var, "fall")) %>%
  plot_corr_only()
```

### Winter primary production
```{r, winter-pp}
here::here(
  "black-sea-bass", "Black sea bass_regression_report_0lag", "data",
  "Black_sea_bass_Mid_MAB_0_lag_FALSE_remove_recent_pp-stock.csv"
) %>%
  prep_data() %>%
  dplyr::filter(stringr::str_detect(Var, "winter")) %>%
  plot_corr_only()
```

### Fall primary production (prior year)
```{r, fall-pp}
here::here(
  "black-sea-bass", "Black sea bass_regression_report_1lag", "data",
  "Black_sea_bass_Mid_MAB_1_lag_FALSE_remove_recent_pp-stock.csv"
) %>%
  prep_data() %>%
  dplyr::filter(stringr::str_detect(Var, "fall")) %>%
  plot_corr_only()
```

### Cold pool index (prior year)
```{r, cold-pool}
data <- here::here(
  "black-sea-bass", "Black sea bass_regression_report_1lag", "data",
  "Black_sea_bass_Mid_MAB_1_lag_FALSE_remove_recent_cold-pool.csv"
) %>%
  prep_data()

for (i in unique(data$Var)) {
  this_data <- data %>%
    dplyr::filter(Var == i)
  plt <- plot_corr_only(this_data, title = i)
  print(plt)
  cat("\n\n")
}
```

### Predator abundance


## Ecosystem

### Sea surface temperature

#### Recruitment
```{r, sst-rec}
here::here(
  "black-sea-bass", "Black sea bass_regression_report_0lag", "data",
  "Black_sea_bass_Mid_MAB_0_lag_FALSE_remove_recent_sst.csv"
) %>%
  prep_data() %>%
  plot_corr_only()
```

#### Abundance
```{r, sst-abun}
here::here(
  "black-sea-bass", "Black sea bass_regression_report_0lag", "data",
  "Black_sea_bass_Mid_MAB_0_lag_FALSE_remove_recent_sst.csv"
) %>%
  prep_data(metric = "Abundance") %>%
  plot_corr_only()
```

### Marine heatwaves

#### Recruitment
```{r, heat-rec}
data <- here::here(
  "black-sea-bass", "Black sea bass_regression_report_0lag", "data",
  "Black_sea_bass_Mid_MAB_0_lag_FALSE_remove_recent_heatwave.csv"
) %>%
  prep_data()

for (i in unique(data$Var)) {
  this_data <- data %>%
    dplyr::filter(Var == i)
  plt <- plot_corr_only(this_data, title = i)
  print(plt)
  cat("\n\n")
}
```

#### Abundance
```{r, heat-abun}
data <- here::here(
  "black-sea-bass", "Black sea bass_regression_report_0lag", "data",
  "Black_sea_bass_Mid_MAB_0_lag_FALSE_remove_recent_heatwave.csv"
) %>%
  prep_data(metric = "Abundance")

for (i in unique(data$Var)) {
  this_data <- data %>%
    dplyr::filter(Var == i)
  plt <- plot_corr_only(this_data, title = i)
  print(plt)
  cat("\n\n")
}
```


## Management

### Total catch
```{r, catch, fig.height = 4.25, fig.width = 3.75}
data <- here::here(
  "black-sea-bass", "Black sea bass_regression_report_0lag", "data",
  "Black_sea_bass_Mid_MAB_0_lag_FALSE_remove_recent_time.csv"
) %>%
  read.csv() %>%
    dplyr::filter(Metric == "Catch") # pull catch only 

my_colors <- c("black", "#B2292E")
    names(my_colors) <- c("FALSE", "TRUE")

    data$sig <- factor(data$sig, levels = c("TRUE", "FALSE"))

    fig <- ggplot2::ggplot(data, ggplot2::aes(
      x = Val,
      y = Value
    )) +
      ggplot2::geom_path(ggplot2::aes(color = Time)) +
      ggplot2::geom_point(ggplot2::aes(color = Time)) +
      ggplot2::scale_color_gradient(
        low = "#7F7FFF",
        high = "#575195", breaks = seq(1950, 2020,
          by = 10
        ),
        name = "Year",
        guide = ggplot2::guide_colorbar(order = 2)
      ) +
      ggnewscale::new_scale_color() +
      ggplot2::stat_smooth(ggplot2::aes(color = sig),
        method = "lm"
      ) +
      ggplot2::scale_color_manual(
        values = my_colors,
        name = "Statistically significant\n(p < 0.05)",
        drop = FALSE,
        guide = ggplot2::guide_legend(order = 1)
      ) +
      ggplot2::scale_y_continuous(labels = scales::comma) +
      ggplot2::theme_bw() +
      ggplot2::labs(title = "Catch over time") +
      ggplot2::ylab(paste(unique(data$Description), unique(data$Units), sep = ", ")) +
      ggplot2::xlab("Year") +
      ggplot2::theme(legend.position = "top",
                     legend.box = "vertical",
                     legend.spacing = ggplot2::unit(0.1, units = "cm"),
                     legend.box.spacing = ggplot2::unit(0.1, units = "cm"))
    
    ggplot2::ggsave(
      filename = paste("figures/",
        unique(data$Var) %>%
          stringr::str_replace_all(" ", "_") %>%
          stringr::str_replace_all("\n", "_"),
        ".png",
        sep = ""
      ),
      width = 3.75,
      height = 4.25,
      units = "in",
      device = "png"
    )
    
return(fig)
```

### CPUE

### Catch vs TAC

### Northern and southern bounds

### Center of gravity
