---
title: "Black_sea_bass_foodhabits"
author: "Ricky Tabandera"
date: "5/12/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gridExtra)
library(grid)
```

## Black sea bass food habits

Black sea bass are diurnal visual predators usually associated with complex hard structured bottoms and are observed to eat a wide variety of prey. Investigations into the food habits of black sea bass as sampled by three bottom trawl surveys (NEFSC, NEAMAP, and CHESAMAP).


```{r data_organization, warning=FALSE, include=FALSE}

#all food habits from condition work +

#load(url("https://github.com/Laurels1/Condition/raw/master/data/allfh.RData"))
# load("C:\\Users\\ricky.tabandera\\Documents\\EDAB\\esp_data_aggregation\\black-sea-bass\\allfh_20200526.rds")
# saveRDS(allfh, file="allfh_20200526.RDS")
load("allfh_20200526.RDATA")
#key of strata from ECSA <- read.csv("https://raw.githubusercontent.com/NOAA-EDAB/ECSA/master/data/seasonal_stock_strata.csv")


CHESAMAP_2022<-read.csv("BSB_CHESAMAP_2022.csv")
NEAMAP_2022<-read.csv("BSB_NEAMAP_2022.csv" )

#col definitions from data dict
#PDLEN	PREDATOR LENGTH	Predator length in CM, rounded up.


#filter all food habits down to just black sea bass svspp code 141
#NEesp::species_key used to get svspp key

#Well-digested prey (unidentifiable animal remains) labeled as WDP.

#removing pre 1991 years as they lack a unique predator id making reconstructing stomachs difficult 
#removing rows without prey weight ~ 400 records removed 
# & year>1990
BSB_allfh<- allfh %>% filter(svspp=="141"  )


#select only used variables PYPERI
BSB_small<-BSB_allfh %>% select(c(pynam, gencat, gensci, analcat,  analsci, 
                                  pyamtw,pywgti,pdid, pdlen,pdsex, pdwgt,pynum, 
                                  geoarea,
                                  stratum, surftemp, bottemp, season,month, day, year,decade ,cruise6,tow))

#remove SAB as contains only ~20 records
BSB_small<-BSB_small %>% filter(!geoarea=="SAB" )






# north vs south
# geo regions in the dataset "MAB" "SNE" "GoM" "GB"  "SAB"
# refactor GOM and GB into SNE as northern subunit, and removed South atlantic bight

BSB_small$subunit <- BSB_small$geoarea

BSB_small$subunit[BSB_small$geoarea=="MAB"]<-"Southern"
BSB_small$subunit[BSB_small$geoarea=="SNE"]<-"Northern"
BSB_small$subunit[BSB_small$geoarea=="GoM"]<-"Northern"
BSB_small$subunit[BSB_small$geoarea=="GB"]<-"Northern"

#removing pre 1991 years as they lack a unique predator id making reconstructing stomachs difficult used for freq
BSB_small_ID<-BSB_small  %>% filter(year>1990)



```

## Frequency of occurance and weight of prey items

NEFSC bottom trawl survey food habits contain a fraction of fish collected in a tow for stomach removal and analysis. Each entry is the identified contents of indevidual black sea bass stomachs associated with a unique predatorID. This dataset contains `r length(unique(BSB_small$pdid))  ` stomachs containing `r length(BSB_small$pdid) ` prey records. Data coverage begins in 1977 though 2020.


```{r}
#create a new index of indevidual bsb as pdid appears to not be reliable at IDing fish early in the dataset
#strata cruise tow station pdid ==== to make key
t1<- BSB_small %>% unite("ID",c(month, day, year,cruise6, pdlen,tow),remove =FALSE)
#generate counts of each prey catagory by year and subunit
t2<-t1 %>% group_by(decade,subunit, analsci ) %>% summarise(count=n())
#count each identified predator for each subunit and year
t3<-t1 %>% group_by(decade,subunit) %>% summarise(pd_count=length(unique(ID)))
#join the above counts to get frequency of occurance in stomachs by region and decade
t4<-dplyr::full_join( t2,t3, by= c("decade","subunit"))

t4<-t4 %>% mutate(freq_o=count/pd_count)



#######testing

#need key to group prey together IE decapoda crab, vs cancer spp, 
# pyamtw is in g

t0<- BSB_small %>% filter(!analsci%in%c("BLOWN"))

t1<- t0 %>% unite("ID",c(month, day, year,cruise6, pdid, pdlen, tow),remove =FALSE)

length(unique(t1$ID))

#generate counts of each prey catagory by year and subunit
t2<-t1 %>% group_by( analsci ) %>% summarise(count=n())

t2<-t2 %>% mutate(f_o=count/length(unique(t1$ID)))
#count each identified predator for each subunit and year
t3<-t1 %>%group_by( analsci )%>%  summarise(pd_count=length(unique(ID)))
#join the above counts to get frequency of occurance in stomachs by region and decade
t4<-dplyr::full_join( t2,t3, by= "analsci")

t4<-t4 %>% mutate(freq_o=count/pd_count)



#remove all blown

t2 %>%
  filter(count>10, !analsci%in%c("","BLOWN", "EMPTY"))%>%
  mutate(analsci=forcats::fct_reorder(analsci, f_o, .desc = TRUE))%>%
  ggplot()+
  geom_bar(aes(x=analsci, y=f_o),stat = "identity")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        legend.position="none"
        )









 # group_by(analsci)%>% 
 #  mutate(analsci=forcats::fct_reorder(analsci, freq_o))%>%
 # 
 #  group_by(analsci)%>%
 #    facet_wrap(vars(subunit,decade))+
  
  

```


```{r prey trial}
t0<- BSB_small %>% filter(!analsci%in%c("BLOWN"))

t1<- t0 %>% unite("ID",c(month, day, year,cruise6, pdlen, tow),remove =FALSE)

length(unique(t1$ID))

#generate counts of each prey catagory by year and subunit
t2<-t1 %>% group_by( pynam ) %>% summarise(count=n())

t2<-t2 %>% mutate(f_o=count/length(unique(t1$ID)))
#count each identified predator for each subunit and year
t3<-t1 %>%group_by( pynam )%>%  summarise(pd_count=length(unique(ID)))
#join the above counts to get frequency of occurance in stomachs by region and decade
t4<-dplyr::full_join( t2,t3, by= "analsci")

t4<-t4 %>% mutate(freq_o=count/pd_count)





t2 %>%
  filter(count>20,!pynam%in%c("EMPTY"))%>%
  mutate(analsci=forcats::fct_reorder(pynam, f_o, .desc = TRUE))%>%
  ggplot()+
  geom_bar(aes(x=pynam, y=f_o),stat = "identity")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        legend.position="none"
        )

```



```{r northern_raw, echo=FALSE}

# PYSPP	Prey species name.

#removing 




N<-BSB_small %>% filter(subunit =="Northern" , !gensci%in%c("EMPTY","","OTHER","BLOWN") & !is.na(pyamtw)) %>% group_by(gensci)%>%
  summarise(count=n(),freq_occ=(count/length(BSB_small$gensci)),weight=sum(pyamtw))


N_weight<-BSB_small %>%
  filter(subunit =="Northern"& !gensci%in%c("EMPTY","","OTHER")) %>%
  group_by(gensci)%>%
  summarise(weight=sum(pyamtw))


N_weight<- N_weight %>% filter(weight>0)%>%
  mutate(perc_weight=weight/sum(weight)*100)  

N_order<-N %>%  mutate(gensci=forcats::fct_reorder(gensci, (count)))


N1<-N %>%
  mutate(gensci=forcats::fct_reorder(gensci, (count))) %>%
  ggplot(aes(x=gensci,y=count, fill= gensci))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        legend.position="none"
        )+
   coord_flip()+
  xlab("Prey category")+
  ylab("count")+
  nmfspalette::scale_fill_nmfs(palette = "regional web")

N2<-N_weight %>%
  mutate(gensci=forcats::fct_reorder(gensci, desc(perc_weight))) %>%
  ggplot(aes(x=N_order$gensci,y=weight, fill=N_order$gensci))+geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position="none"
        )+
  scale_y_reverse()+
  coord_flip()+
  ylab("Weight (g)")+
  nmfspalette::scale_fill_nmfs(palette = "regional web")


plot_N<-ggpubr::ggarrange(N2,N1,ncol=2)

ggpubr::annotate_figure(plot_N,top = ggpubr::text_grob("Northern area food habits", 
               color = "red", face = "bold", size = 14))



```

```{r southern_raw, echo=FALSE, message=FALSE, warning=FALSE}





S<-BSB_small %>% filter(subunit =="Southern" & !gensci%in%c("EMPTY","","OTHER") & !is.na(pyamtw)) %>% group_by(gensci) %>%
  summarise(count=n(),freq_occ=(count/length(BSB_small$gensci)),weight=sum(pyamtw))


S_weight<-BSB_small %>% 
  filter(subunit =="Southern"& !gensci%in%c("EMPTY","","OTHER")) %>%
  group_by(gensci) %>% 
  summarise(weight=sum(pyamtw))

S_weight<- S_weight %>%
  filter(weight>0)%>% 
  mutate(perc_weight=weight/sum(weight)*100)  

S_order<-S %>%  mutate(gensci=forcats::fct_reorder(gensci, (count)))


S1<-S %>%
  mutate(gensci=forcats::fct_reorder(gensci, (count))) %>%
  ggplot(aes(x=gensci,y=count, fill= gensci))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        legend.position="none"
        )+
   coord_flip()+
  xlab("Prey category")+
  ylab("count")+
  nmfspalette::scale_fill_nmfs(palette = "regional web")

S2<-S_weight %>%
  mutate(gensci=forcats::fct_reorder(gensci, desc(perc_weight))) %>%
  ggplot(aes(x=S_order$gensci,y=weight, fill=S_order$gensci))+geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position="none"
        )+
  scale_y_reverse()+
  coord_flip()+
  ylab("Weight (g)")+
  nmfspalette::scale_fill_nmfs(palette = "regional web")


plot_S<-ggpubr::ggarrange(S2,S1,ncol=2)

ggpubr::annotate_figure(plot_S,top = ggpubr::text_grob("Southern area food habits", 
               color = "red", face = "bold", size = 14))

```


```{r Frequency_occ, echo=FALSE, message=FALSE, warning=FALSE}
#removing 
t1<-BSB_small_ID %>% filter(year==1991)
t2<-BSB_small_ID %>% filter(year==1992)
t3<-BSB_small_ID %>% filter(year==2012)
  
t3 %>% filter(pdid==177479)
  # group_by(year) %>%
  # summarise(nstom=unique(pdid))
  
  
  t4<-t3 %>% group_by(pdid) %>% summarise(count=n())
  


BSB_small_ID %>%
  group_by(pynam) %>%
  summarise(count=n())%>%
  filter(count>10) %>%
  mutate(pynam=forcats::fct_reorder(pynam, desc(count))) %>%
  ggplot(aes(x=pynam, y=count))+geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90) )

```







## NEAMAP

```{r NEAMAP_RAW, echo=FALSE, message=FALSE, warning=FALSE}
# total prey items 8227, 
NEAMAP_2022 %>%
  filter(Frequency>100)%>%
  mutate(Common_order=forcats::fct_reorder(COMMON, Frequency)) %>%
  ggplot(aes(x=Common_order,y=Frequency, fill= COMMON))+geom_bar(stat = "identity")+
  coord_flip()+
  theme(
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        legend.position="none"
        )+
  ggtitle("NEAMAP raw freq")

```

##CHESAMAP

```{r CHESAMAP_RAW, echo=FALSE, message=FALSE, warning=FALSE}

CHESAMAP_2022 %>%
  filter(Frequency>15)%>%
  mutate(Common_order=forcats::fct_reorder(COMMON, Frequency)) %>%
  ggplot(aes(x=Common_order,y=Frequency, fill= COMMON))+geom_bar(stat = "identity")+
  coord_flip()+
  theme(
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"),
        axis.title.y=element_blank(),
        legend.position="none"
        )+
  ggtitle("CHESAMAP raw freq")

```


