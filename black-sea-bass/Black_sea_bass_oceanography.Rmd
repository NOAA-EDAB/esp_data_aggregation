---
title: "BSB Oceanography"
author: "Ricky Tabandera"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
# library("readxl")

```



```{r Excel_cleaning, include=FALSE}

# SHW_SMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\ShelfWaterVolume_BSB_update.xlsx",sheet =1)
# SHW_NMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\ShelfWaterVolume_BSB_update.xlsx",sheet =2)
# SHW_MAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\ShelfWaterVolume_BSB_update.xlsx",sheet =3)
# 
# SHW_SMAB %>% write.csv("SHW_SMAB.csv")
# SHW_NMAB %>% write.csv("SHW_NMAB.csv")
# SHW_MAB %>% write.csv("SHW_MAB.csv")
# 
# 
# TSanom_WGOM<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 1)
# TSanom_WGB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 2)
# TSanom_SMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 3)
# TSanom_NMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 4)
# TSanom_MAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 5)
# 
# 
# TSanom_WGOM  %>% write.csv("TSanom_WGOM.csv")
# TSanom_WGB  %>% write.csv("TSanom_WGB.csv")
# TSanom_SMAB  %>% write.csv("TSanom_SMAB.csv")
# TSanom_NMAB %>% write.csv("TSanom_NMAB.csv")
# TSanom_MAB %>% write.csv("TSanom_MAB.csv")



SHW_SMAB <- read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\SHW_SMAB.csv")
SHW_NMAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\SHW_NMAB.csv")
SHW_MAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\SHW_MAB.csv")



TSanom_WGOM<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_WGOM.csv")
TSanom_WGB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_WGB.csv")
TSanom_SMAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_SMAB.csv")
TSanom_NMAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_NMAB.csv")
TSanom_MAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_MAB.csv")




############## mutate data to incude season

#convert decimal year to date
SHW_SMAB$date_ymd<-lubridate::date_decimal(SHW_SMAB$Year, tz = "UTC")
SHW_NMAB$date_ymd<-lubridate::date_decimal(SHW_NMAB$Year, tz = "UTC")
SHW_MAB$date_ymd<-lubridate::date_decimal(SHW_MAB$Year, tz = "UTC")

#extract month


SHW_SMAB$month<-lubridate::month(SHW_SMAB$date_ymd) 
SHW_NMAB$month<-lubridate::month(SHW_NMAB$date_ymd) 
SHW_MAB$month<-lubridate::month(SHW_MAB$date_ymd) 
######## extract year

SHW_SMAB$year<-lubridate::year(SHW_SMAB$date_ymd)
SHW_NMAB$year<-lubridate::year(SHW_NMAB$date_ymd)
SHW_MAB$year<-lubridate::year(SHW_MAB$date_ymd)

# limit to just winter months feb-mar as jan is irregularly avalible 
#very few december measurments

SHW_SMAB<-SHW_SMAB %>%
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  ) 



                     
SHW_SMAB<-SHW_SMAB %>% 
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )    

SHW_NMAB<-SHW_NMAB %>%  
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )


SHW_MAB<-SHW_MAB %>% 
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )

#summerize to mean winter for each variable of interest 
SHW_SMAB_winter <-SHW_SMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom), ShW.T.anom)
                         
SHW_NMAB_winter <-SHW_NMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))

 SHW_MAB_winter <-SHW_MAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))
 
#Fall 
 
SHW_SMAB_fall <-SHW_SMAB %>% filter(season=="fall") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))
                         
SHW_NMAB_fall <-SHW_NMAB %>% filter(season=="fall") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))

 SHW_MAB_fall <-SHW_MAB %>% filter(season=="fall") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom)) 
 
######### calculate anomoly for bottom T and S
 

TSanom_SMAB<-TSanom_SMAB %>% mutate(T_anom = (T -Annual.Avg.T),S_anom = S -Annual.Avg.S)
TSanom_NMAB<-TSanom_NMAB %>% mutate(T_anom = (T -Annual.Avg.T),S_anom = S -Annual.Avg.S)



 
 
 
#convert decimal year to date
TSanom_WGOM$year_date<-lubridate::date_decimal(TSanom_WGOM$Year, tz = "UTC")
#extract month

TSanom_WGOM$month<-lubridate::month(TSanom_WGOM$year_date) 
TSanom_WGOM$year<-lubridate::year(TSanom_WGOM$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_WGOM<-TSanom_WGOM %>%  
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )
                         


#################### convert decimal date to month and classify to a season 


#convert decimal year to date
TSanom_WGB$year_date<-lubridate::date_decimal(TSanom_WGB$Year, tz = "UTC")
#extract month

TSanom_WGB$month<-lubridate::month(TSanom_WGB$year_date) 
TSanom_WGB$year<-lubridate::year(TSanom_WGB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_WGB<-TSanom_WGB %>% 
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )
                         


#convert decimal year to date
TSanom_SMAB$year_date<-lubridate::date_decimal(TSanom_SMAB$Year, tz = "UTC")
#extract month

TSanom_SMAB$month<-lubridate::month(TSanom_SMAB$year_date) 
TSanom_SMAB$year<-lubridate::year(TSanom_SMAB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_SMAB<-TSanom_SMAB %>%   
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )


#convert decimal year to date
TSanom_NMAB$year_date<-lubridate::date_decimal(TSanom_NMAB$Year, tz = "UTC")
#extract month

TSanom_NMAB$month<-lubridate::month(TSanom_NMAB$year_date) 
TSanom_NMAB$year<-lubridate::year(TSanom_NMAB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_NMAB<-TSanom_NMAB %>% 
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )                   
                         



###########################
#convert decimal year to date
TSanom_MAB$year_date<-lubridate::date_decimal(TSanom_MAB$Year, tz = "UTC")
#extract month
TSanom_MAB$month<-lubridate::month(TSanom_MAB$year_date) 
TSanom_MAB$year<-lubridate::year(TSanom_MAB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_MAB<-TSanom_MAB %>% 
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )




########################

# calculate winter means and filter to only winter values


WGOM_winter_bot<-TSanom_WGOM %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ))

WGB_winter_bot<-TSanom_WGB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ))

SMAB_winter_bot<-TSanom_SMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ),mean_bot_T_anom=mean(T_anom,na.rm=T), mean_bot_S_anom=mean(S_anom,na.rm=T ) )

NMAB_winter_bot<-TSanom_NMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ),mean_bot_T_anom=mean(T_anom,na.rm=T), mean_bot_S_anom=mean(S_anom,na.rm=T ))

MAB_winter_bot<-TSanom_MAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ))
 







```

## Shelf water volume

Shelf water volume which is a measure of the volume of water bounded inshore of a hydrodynamic feature called the shelf-slope front. In this analysis the shelf water is defined as all water having salinity <34. It is hypothesized that fish are migrating from the self edge and using the shelf slope font as a way-point. The position of this front will vary inter-annually with the higher values indicating the front being pushed further towards the shelf break. As this font moves closer or further from the coast, the available susceptible habitat can expand or contract as black sea bass are known to concentrate slope ward of the front. Miller et al. 2016 Identified a negative impact on catches of both juveniles and adult black sea bass when shelf water volume exceeded 4000 km^3

```{r Shelf water volume, eval=FALSE, warning=FALSE, include=FALSE}
SHW_SMAB_plot<-SHW_SMAB %>% 
  ggplot2::ggplot()+
  geom_line(aes(x=Year, y=ShW.Vol), width = .51, color="black",fill="lightgrey")+
  geom_point(aes(x=Year, y=ShW.Vol))+
  geom_hline(yintercept = 0)+
  ylab(expression(Shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(1000,6000, by= 1000))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Southern Mid Atlantic Bight")

SHW_NMAB_plot<-SHW_NMAB %>% 
  ggplot2::ggplot()+
  geom_line(aes(x=Year, y=ShW.Vol), width = .51, color="black",fill="lightgrey")+
  geom_point(aes(x=Year, y=ShW.Vol))+
  ylab(expression(Shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(1000,6000, by= 1000))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Northern Mid Atlantic Bight")

SHW_MAB_plot<-SHW_MAB %>% 
  ggplot2::ggplot()+
  geom_line(aes(x=Year, y=ShW.Vol), width = .51, color="black",fill="lightgrey")+
  geom_point(aes(x=Year, y=ShW.Vol))+
  geom_hline(yintercept = 0)+
  ylab(expression(Shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(1000,6000, by= 1000))+
  geom_hline(yintercept=4000, linetype="dashed", color = "red")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("All Mid Atlantic Bight")





  
```

```{r SHW_PLOTS, eval=FALSE, include=FALSE}
plot(SHW_SMAB_plot)
plot(SHW_NMAB_plot)
plot(SHW_MAB_plot)
```


```{r SWVanom, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

SHW_SMAB_anom_plot<-SHW_SMAB %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=Year, y=ShW.Vol.anom, fill=ShW.T), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Southern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")
  
SHW_NMAB_anom_plot  <-SHW_NMAB %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=Year, y=ShW.Vol.anom, fill=ShW.T), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Northern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")
  
SHW_MAB_anom_plot  <-SHW_MAB %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=Year, y=ShW.Vol.anom, fill=ShW.T), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("All Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

plot(SHW_SMAB_anom_plot)
plot(SHW_NMAB_anom_plot)
plot(SHW_MAB_anom_plot)


```


## winter shelf water volume

```{r winter_shelf_water_vol_anom, echo=FALSE, message=FALSE, warning=FALSE}
SHW_SMAB_winter_plot<-SHW_SMAB_winter %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y= mean_SHW , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Winter~shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(0,3000, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Southern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

SHW_NMAB_winter_plot<-SHW_NMAB_winter %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y= mean_SHW , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Winter~shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(0,3000, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Northern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

SHW_MAB_winter_plot<-SHW_SMAB_winter %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y= mean_SHW , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Winter~shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(0,3000, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("All Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

##############


SHW_anom_SMAB_winter_plot<-SHW_SMAB_winter %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y=mean_SHW_anom , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Winter~shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Southern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

SHW_anom_NMAB_winter_plot<-SHW_NMAB_winter %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y=mean_SHW_anom , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Winter~shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Northern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

SHW_anom_MAB_winter_plot<-SHW_SMAB_winter %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y=mean_SHW_anom , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Winter~shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("All Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

plot(SHW_SMAB_winter_plot)
plot(SHW_NMAB_winter_plot)
plot(SHW_MAB_winter_plot)

plot(SHW_anom_SMAB_winter_plot)
plot(SHW_anom_NMAB_winter_plot)
plot(SHW_anom_MAB_winter_plot)

```



```{r fall_shelf_water_vol_anom, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}


SHW_SMAB_fall_plot<-SHW_SMAB_fall %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y=mean_SHW_anom , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Fall~shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Southern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")


SHW_NMAB_fall_plot<-SHW_NMAB_fall %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y=mean_SHW_anom , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Fall~shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Northern Mid Atlantic Bight")+
  labs(fill="Temperature (C)")


SHW_MAB_fall_plot<-SHW_MAB_fall %>% 
  ggplot2::ggplot()+
  geom_col(aes(x=year, y=mean_SHW_anom , fill=mean_SHW_T ), width = .51, )+
  geom_hline(yintercept = 0)+
  ylab(expression(Fall~shelf~water~volume~anomoly~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(-1500,1500, by= 500))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("All Mid Atlantic Bight")+
  labs(fill="Temperature (C)")

plot(SHW_SMAB_fall_plot)
plot(SHW_NMAB_fall_plot)
plot(SHW_MAB_fall_plot)


```


## Regional in-situ winter bottom temperature and salinity with anomaly

All available CTD data within 10m of the bottom between the northern and southern MAB region and as a whole. Regional time series were computed as follows: area-weighted regional mean values were computed for each survey in the OCDBS and a reference annual cycle was removed (fit to observations from 1981-2010) to get seasonal anomalies. 

note: winter coverage is very sparse due to the winter ECOMON surveys ending. A better approach may to be to use a two month span at the end of winter where coverage is better i.e. FEB-MAR rather than a whole winter. 


```{r regional_t_s_plots, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# TSanom_WGOM_T_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# 
# 
# TSanom_WGOM_S_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# #####################
# 
# TSanom_WGB_T_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# TSanom_WGB_S_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# #################
# TSanom_SMAB_T_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# 
# 
# TSanom_SMAB_S_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# #######  
# 
# TSanom_NMAB_T_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
# 
# 
# 
# TSanom_NMAB_S_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
#   
# #############
# 
# 
# TSanom_MAB_T_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
# 
# 
# 
# TSanom_MAB_S_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
#   
# plot(TSanom_WGOM_T_plot)
# plot(TSanom_WGOM_S_plot)
# 
# plot(TSanom_WGB_T_plot)
# plot(TSanom_WGB_S_plot)
# 
# 
# plot(TSanom_SMAB_T_plot)
# plot(TSanom_SMAB_S_plot)
# 
# plot(TSanom_NMAB_T_plot)
# plot(TSanom_NMAB_S_plot)
# 
# plot(TSanom_MAB_T_plot)
# plot(TSanom_MAB_S_plot)

```

```{r regional_t_s_anom_plots, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# TSanom_WGOM_Tanom_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y= (`T`-Annual.Avg.T) ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# 
# 
# TSanom_WGOM_S_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# #####################
# 
# TSanom_WGB_T_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# TSanom_WGB_S_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# #################
# TSanom_SMAB_T_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# 
# 
# TSanom_SMAB_S_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# #######  
# 
# TSanom_NMAB_T_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
# 
# 
# 
# TSanom_NMAB_S_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
#   
# #############
# 
# 
# TSanom_MAB_T_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
# 
# 
# 
# TSanom_MAB_S_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
#   
# plot(TSanom_WGOM_T_plot) 
# plot(TSanom_WGOM_S_plot)
# 
# plot(TSanom_WGB_T_plot)
# plot(TSanom_WGB_S_plot)
# 
# 
# plot(TSanom_SMAB_T_plot)
# plot(TSanom_SMAB_S_plot)
# 
# plot(TSanom_NMAB_T_plot)
# plot(TSanom_NMAB_S_plot)
# 
# plot(TSanom_MAB_T_plot)
# plot(TSanom_MAB_S_plot)

```


```{r winter_bottom_temp_and_salinity, echo=FALSE, message=FALSE, warning=FALSE}


WGOM_winter_bot_plot<-WGOM_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Western Gulf Of Maine")

###############

WGB_winter_bot_plot<-WGB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Western Georges bank")


####################



SMAB_winter_bot_plot<-SMAB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Southern Mid Atlantic Bight")

##################################



NMAB_winter_bot_plot<-NMAB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Northern Mid Atlantic Bight")

##############

MAB_winter_bot_plot<-MAB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("All Mid Atlantic Bight")


#########################


plot(WGOM_winter_bot_plot)
plot(WGB_winter_bot_plot)
plot(SMAB_winter_bot_plot)
plot(NMAB_winter_bot_plot)
plot(MAB_winter_bot_plot)


```



## Gulf Stream Index
The GSI is calculated based on the method presented by Pérez-Hernández and Joyce (2014). This gulf stream index is a position anomaly meaning the larger the value of the index the further north the northern wall of the Gulf Stream is for that year.


```{r Gulf_stream_index, echo=FALSE}
GSI<-ecodata::gsi

GSI %>%
  dplyr::mutate(Year = floor(Time)) %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Value = mean(Value)) %>%
  dplyr::mutate(hline = mean(Value)) %>%
  ggplot(aes(x=Year, y=Value))+
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::ylab("Gulf Stream position anomaly") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Gulf Stream Index") +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01),breaks = seq(1950,2021, by= 5))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))
 


GSI_annual<-GSI %>%
  dplyr::mutate(Year = floor(Time)) %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Value = mean(Value)) %>%
  dplyr::mutate(hline = mean(Value))


```


```{r export_data, include=FALSE}

# write.csv(SHW_SMAB_winter, file="SHW_SMAB_winter.csv")
# write.csv(SHW_SMAB_winter, file="SHW_NMAB_winter.csv")
# write.csv(SHW_SMAB_winter, file="SHW_MAB_winter.csv")
# 
# 
# write.csv(NMAB_winter_bot, file="SMAB_winter_bot.csv")
# write.csv(NMAB_winter_bot, file="NMAB_winter_bot.csv")
# write.csv(NMAB_winter_bot, file="MAB_winter_bot.csv")
# 
# write.csv(GSI_annual, file = "GSI_annual.csv")


```



## Cross correlation testing

Explorations into the association between bottom conditions and Black sea bass recruitment deviations. recruitment deviations from the 2021 operational assessment. This model output lacks 2020 data and thus 2019 is the terminal year. Bottom conditions are also limited to this time span. Temperature anomaly are used to avoid seasonal and annual patterns. The association is likely to occur with a time lag as current conditions would likely manifest in following years. Horizontal line indicates significant cross correlation   



```{r cor_testing, message=FALSE, warning=FALSE, include=FALSE}
# install.packages("astsa")
# install.packages("TSstudio")
# install.packages("timetk")
# install.packages("forecast")



# read in recruitment deveations from the 2021 opperational assesment. This model output lacks 2020 data and thus 2019 is the terminal year



South_rec_dev<-read.csv("~//EDAB//esp_data_aggregation//black-sea-bass//South_rec_dev.csv")
North_rec_dev<-read.csv("~//EDAB//esp_data_aggregation//black-sea-bass//North_rec_dev.csv")


South_rec_dev$recruit_dev_Ln<-exp(South_rec_dev$log_recruit_devs)
South_rec_dev$recruit_dev_log10<-(10^(South_rec_dev$log_recruit_devs))

#limit bottom mesurments to align with the years with recruitment deveations
# 1989-2019

SMAB_winter_bot_89<-SMAB_winter_bot %>% filter(year %in% (1989:2019))
NMAB_winter_bot_89<-NMAB_winter_bot %>% filter(year %in% (1989:2019))



S_rec_temp<-dplyr::full_join (South_rec_dev,SMAB_winter_bot_89, by="year")
N_rec_temp<-dplyr::full_join (North_rec_dev,NMAB_winter_bot_89, by="year")




```


```{r Time series vis, echo=FALSE, message=FALSE, warning=FALSE}

S_rec_plot<-S_rec_temp %>% ggplot(aes(x= year,y=log_recruit_devs))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Log recruitment deviation")+
  ggtitle("Log recruitment deviations",subtitle = "Southern MAB")+
  theme_minimal()

N_rec_plot<-N_rec_temp %>% ggplot(aes(x= year,y=log_recruit_devs))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Log recruitment deviation")+
  ggtitle("Log recruitment deviations",subtitle = "Northern MAB")+
  theme_minimal()

rec_plot<-ggpubr::ggarrange(S_rec_plot,N_rec_plot, nrow = 2,ncol = 1)

S_temp_ts_plot<-S_rec_temp %>% ggplot(aes(x=year, y=mean_bot_T_anom))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Temperature anomaly")+
  ggtitle("Winter bottom",subtitle = "Southern MAB")+
  theme_minimal()

N_temp_ts_plot<-N_rec_temp %>% ggplot(aes(x=year, y=mean_bot_T_anom))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Temperature anomaly")+
  ggtitle("Winter bottom",subtitle = "Northern MAB")+
  theme_minimal()


temp_ts_plot<-ggpubr::ggarrange(S_temp_ts_plot,N_temp_ts_plot, nrow = 2,ncol = 1)


plot(rec_plot)

  



```


```{r temp_plots, echo=FALSE}
plot(temp_ts_plot)
```


### Pearsons correlations

#### Bottom temperature

Associations between model estimates of recruitment and environmental indicators is tested using Pearsons correlations. Mean winter bottom temperature is signifcantly correlated within year estimates of recruitment in both regions  (South. P-value = 0.012, t = 2.69, r=0.467; North, P-value = 0.013, t = 2.68, r= 0.480). No signifcant associations were found for lags of one or two years in mean bottom temperatures across regions. Temperature anomalys display a similar significance level and mangitude of associaiton to in-situ temperature values.

#### Bottom Salinity 

No significant associations found in either region (South. P-value = 0.880, t = 0.151, r=0.029; North, P-value = 0.080, t = 2.68, r= 0.353). Simiarly nither one or two year lags were found to be associated with recruitment deviation.


#### Winter Shelf water volume 
No significant associations found in either region (South, t = -1.00, p-value = 0.321, r= -0.13; North t = -1.098, p-value = 0.283, r= -0.210). Additionally no lags had significant associations for either of one or two years of winter shelf water volume. 

```{r Simple_correlation, echo=FALSE, message=FALSE, warning=FALSE}

#Join recrutment and bottom measurments by year for both regions
South_rec_join<-dplyr::left_join(South_rec_dev,SMAB_winter_bot,by="year")

North_rec_join<-dplyr::left_join(North_rec_dev,NMAB_winter_bot,by="year")

#used to test with funtions sensitive to NAs
S_rec_c<-South_rec_join %>%  na.omit()

N_rec_c<-North_rec_join %>%  na.omit()

# lag recruitment by suspected 1 or 2 year increments to check for differences in correlations 

South_rec_join$T_lag1<-dplyr::lag(South_rec_join$mean_bot_T,1)
South_rec_join$T_lag2<-dplyr::lag(South_rec_join$mean_bot_T,2)

North_rec_join$T_lag1<-dplyr::lag(North_rec_join$mean_bot_T,1)
North_rec_join$T_lag2<-dplyr::lag(North_rec_join$mean_bot_T,2)


# lag temperature anomaly to check if it improves or changes association
South_rec_join$T_A_lag1<-dplyr::lag(South_rec_join$mean_bot_T_anom,1)
South_rec_join$T_A_lag2<-dplyr::lag(South_rec_join$mean_bot_T_anom,2)

North_rec_join$T_A_lag1<-dplyr::lag(North_rec_join$mean_bot_T_anom,1)
North_rec_join$T_A_lag2<-dplyr::lag(North_rec_join$mean_bot_T_anom,2)

# correlation test within year

South_rec_cor<-South_rec_join %>%  with(cor.test(mean_bot_T, log_recruit_devs, method=c("pearson")))
#significant P= 0.012, r= 0.467

#correlation test with temperature lagged by 1 year I.E  2000 recruitment as a result of 1999 winter
South_rec_cor_lag1<-South_rec_join %>%  with(cor.test(T_lag1, log_recruit_devs, method=c("pearson")))
#non significant and low r estimate


# correlation test with temperature lagged by 2 year I.E  2000 recruitment as a result of 1998 winter 
South_rec_cor_lag2<-South_rec_join %>%  with(cor.test(T_lag2, log_recruit_devs, method=c("pearson")))
# non-significant and negitive r value


# correlation test with temperature anomaly display near identical pattern of within year correlations but no associations when lagged by 1 or 2

South_rec_cor_A<-South_rec_join %>%  with(cor.test(mean_bot_T_anom, log_recruit_devs, method=c("pearson")))
South_rec_cor_A_lag1<-South_rec_join %>%  with(cor.test(T_A_lag1, log_recruit_devs, method=c("pearson")))
South_rec_cor_A_lag2<-South_rec_join %>%  with(cor.test(T_A_lag2, log_recruit_devs, method=c("pearson")))





####################################

#correlations within year 
North_rec_cor<-North_rec_join %>% with(cor.test(mean_bot_T  , log_recruit_devs    , method=c("pearson")))
#significant P=0.013, r=0.480


#correlation test with temperature lagged by 1 year I.E  2000 recruitment as a result of 1999 winter
North_rec_cor_lag1<-North_rec_join %>% with(cor.test(T_lag1 , log_recruit_devs    , method=c("pearson")))
# non-significant and low r value


#correlation test with temperature lagged by 1 year I.E  2000 recruitment as a result of 1998 winter
North_rec_cor_lag2<-North_rec_join %>% with(cor.test(T_lag2 , log_recruit_devs    , method=c("pearson")))
# non-significant and negitive r value

#similar pattern in north


############# visualize significant correlations 




South_rec_cor_plot<-South_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs))+
  geom_point()+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=10,y=.5,label="r =0.47, P-value=0.012")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "southern MAB")



########################## northern correlations 

N_test_log<-North_rec_join %>%  with(cor.test(mean_bot_T  , log_recruit_devs    , method=c("pearson")))

North_rec_cor_plot<-North_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs))+
  geom_point()+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=7.8,y=2,label="r =0.48, P-value=0.013")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "Northern MAB")



plot(South_rec_cor_plot)
plot(North_rec_cor_plot)


#########################################

#salinity correlations with recruitment

S_sal_log<-South_rec_join %>%  with(cor.test(mean_bot_S   , log_recruit_devs    , method=c("pearson")))

N_sal_log<-North_rec_join %>%  with(cor.test(mean_bot_S   , log_recruit_devs    , method=c("pearson")))


S_sal_log_lag1<-South_rec_join %>%  with(cor.test(lag(mean_bot_S,1)   , log_recruit_devs    , method=c("pearson")))

N_sal_log_lag1<-North_rec_join %>%  with(cor.test(lag(mean_bot_S,1 )  , log_recruit_devs    , method=c("pearson")))

S_sal_log_lag2<-South_rec_join  %>%  with(cor.test(lag(mean_bot_S,2)   , log_recruit_devs    , method=c("pearson")))

N_sal_log_lag2<-North_rec_join %>%  with(cor.test(lag(mean_bot_S,2 )  , log_recruit_devs    , method=c("pearson")))



#######################

# Shelf water volume associations



South_SHW_join<-left_join(South_rec_dev,SHW_SMAB_winter, by= "year")

North_SHW_join<-left_join(North_rec_dev,SHW_NMAB_winter, by= "year")

South_SHW_log<-South_SHW_join %>%  with(cor.test(mean_SHW   , log_recruit_devs    , method=c("pearson")))

North_SHW_log<-North_SHW_join %>%  with(cor.test(mean_SHW   , log_recruit_devs    , method=c("pearson")))

South_SHW_log_lag1<-South_SHW_join %>%  with(cor.test(lag(mean_SHW,1)   , log_recruit_devs    , method=c("pearson")))

Nouth_SHW_log_lag1<-North_SHW_join %>%  with(cor.test(lag(mean_SHW ,1)  , log_recruit_devs    , method=c("pearson")))

South_SHW_log_lag2<-South_SHW_join %>%  with(cor.test(lag(mean_SHW,2)   , log_recruit_devs    , method=c("pearson")))

North_SHW_log_lag1<-North_SHW_join %>%  with(cor.test(lag(mean_SHW ,2)  , log_recruit_devs    , method=c("pearson")))




```














### linear models

The association in mean winter bottom temperature is further investigated using linear models. Significant relationships were found between bottom temperature and recruitment deviation. Model residuals do not display any concerning patterns and positive relationships observed in both regions. 



```{r rec_lm, echo=FALSE}



south_lm<- lm(log_recruit_devs~mean_bot_T,data =South_rec_join)

South_res<-data.frame(residuals=south_lm$residuals,fitted=fitted(south_lm))

South_res_plot<-South_res %>% ggplot(aes(x= fitted, y=residuals))+
  geom_point()+
  ggplot2::geom_hline(yintercept =0)+
  ggtitle("Model residuals vs fitted Southern MAB")

South_lm_plot<-South_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x)+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=11,y=.5,label="R^2 = 0.218,	Adj R^2 = 0.188, P-value=0.012")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "southern MAB")


#####################

North_lm<- lm(log_recruit_devs~mean_bot_T,data =North_rec_join)

North_res<-data.frame(residuals=North_lm$residuals,fitted=fitted(North_lm))

#summary(North_lm)

North_res_plot<-North_res %>% 
  ggplot(aes(x= fitted, y=residuals))+
  geom_point()+
  ggplot2::geom_hline(yintercept =0)+
  ggtitle("Model residuals vs fitted Northern MAB")

North_lm_plot<-North_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x)+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=8,y=2,label="R^2 = 0.230,	Adj R^2 = 0.199, P-value=0.015")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "Northern MAB")


plot(South_lm_plot)

plot(South_res_plot)

plot(North_lm_plot)

plot(North_res_plot)


```
















### Autocorrelation function 
Searching for Autocorrelation within each variable is useful for identifiying the types of structure the data may contain. Each time series is correlated with itself at differing time lags.

#### Bottom temp anomaly ACF
Appears to display minimal issues with autocorrelations, and appears to be similar to white noise for both Northern and southern regions

```{r S_temp_ACF, echo=FALSE}



South_rec_dev_ts<-ts(South_rec_dev$log_recruit_devs,frequency =1, start = 1989, end = 2019)
North_rec_dev_ts<-ts(North_rec_dev$log_recruit_devs,frequency =1, start = 1989, end = 2019)


South_temp_ts<-ts(SMAB_winter_bot_89$mean_bot_T_anom,frequency =1, start = 1989, end = 2019)
North_temp_ts<-ts(NMAB_winter_bot_89$mean_bot_T_anom,frequency =1, start = 1989, end = 2019)

acf(South_temp_ts, main = "Southern MAB bottom temp anomaly")




```


```{r N_temp_ACF, echo=FALSE}

acf(North_temp_ts, main = "Northern MAB bottom temp anomaly")
```







#### Stationarity
Augmented Dickey-Fuller Test indicates that recrutment time serise are not stationary. Recrutment deviations are however are corrected into stationarity when differenced, converting the data from original values to sequential rate changes in time. IE, each value is the difference of preceding years $$Y_{t}-Y_{t-1}$$

```{r Difference testing , eval=FALSE, include=FALSE}
#Testing for stationarity of original time serise 
ADFT_table_SR<-tseries::adf.test(South_rec_dev_ts)
ADFT_table_ST<-tseries::adf.test(South_temp_ts)
ADFT_table_NR<-tseries::adf.test(North_rec_dev_ts)
ADFT_table_NT<-tseries::adf.test(North_temp_ts)
#non stationary as formulated

# s.test<-urca::ur.df(South_rec_dev_ts,type = "trend", lags = 2)
# urca::summary(s.test)


tseries::kpss.test(diff(South_rec_dev_ts))
tseries::adf.test(diff(South_rec_dev_ts))
tseries::adf.test(diff(South_rec_dev_ts))

forecast::ndiffs(South_rec_dev_ts)
forecast::ndiffs(North_rec_dev_ts)


forecast::ndiffs(North_temp_ts)
forecast::ndiffs(North_temp_ts)

# forecast::auto.arima(South_rec_dev_ts)

```




### southern MAB ccf 

Cross Correlation Functions are useful in identifying lags in a time serise that may be predictors of another serise. This test indicates that there is a significant positive correlation between the rate of change in recruitment deviations and bottom temperature anomaly. There is more positive devation from model predictions when the previouse years anomaly is higher.

IE, the positive bottom temperature amomaly in 1999 is associated with increasing rate of recuitment deviations in 2000



```{r southern_mab_ccf, echo=FALSE, message=FALSE, warning=FALSE}


#ccf(South_rec_dev$log_recruit_devs,SMAB_winter_bot_89$mean_bot_T_anom)


# s_ccf_log<-ccf(diff(South_rec_dev$log_recruit_devs),SMAB_winter_bot_89$mean_bot_T_anom)
# s_x<-c(-11:11)
# s_y<-c(s_ccf_log$acf)
# 
# 
# s_ccf_log_tidy<-as.data.frame(cbind(s_x,s_y))
# 
# s_ccf_plot<-
#   s_ccf_log_tidy %>% 
#   ggplot(aes(x=s_x,y=s_y))+
#   geom_col(width = .1)+
#   geom_hline(yintercept = c(.35,-.35))+
#   xlab("Lag")+
#   ylab("CCF")+
#   scale_x_continuous(limits = c(-1,6), breaks = seq(0,6,1))+
#   ggtitle("Log recruitment deviations & winter bottom temperature anomaly", subtitle = "Southern MAB")+
#   theme_minimal()
# 
# 
# plot(s_ccf_plot)
# 

astsa::ccf2(diff(South_rec_dev$log_recruit_devs),SMAB_winter_bot_89$mean_bot_T_anom, main="Log recruitment deviations & winter bottom temperature anomaly")


# cor(x = lag(S_rec_temp$mean_bot_T_anom,2),y=S_rec_temp$diff_rec, use = "complete.obs",method = "pearson")
# astsa::lag2.plot(diff(South_rec_dev$log_recruit_devs),SMAB_winter_bot_89$mean_bot_T_anom, 3,corr	=TRUE)





```

### southern MAB ccf visualizations

Range of lagged winter bottom temperature scatterplots with a lowess fit smoother displayed. Lag of 1 year has a positive correlations to rate of recuitment deviation. 

```{r SMAB_scatter, echo=FALSE}

#significant cross correlations at lags 1 and 2, 


astsa::lag2.plot(SMAB_winter_bot_89$mean_bot_T_anom,diff(South_rec_dev$log_recruit_devs),5)

 
```



### Shelf water volume and recruitment CCF 

No significant correlations between Shelf water volume anomaly and the rate of recruitment deviations in either region



```{r SHW CCF, echo=FALSE, message=FALSE, warning=FALSE}


SHW_NMAB_winter$mean_SHW_anom


forecast::ndiffs(SHW_SMAB_winter$mean_SHW_anom)
forecast::ndiffs(SHW_NMAB_winter$mean_SHW_anom)

acf(SHW_SMAB_winter$mean_SHW_anom)
acf(SHW_NMAB_winter$mean_SHW_anom)

SHW_NMAB_ts<-ts(SHW_NMAB_winter$mean_SHW_anom, start =1978, end= 2019, frequency =1 )

tseries::adf.test(diff(SHW_NMAB_ts))

astsa::ccf2(diff(South_rec_dev$log_recruit_devs),SHW_SMAB_winter$mean_SHW_anom, main="Log recruitment deviations & winter Shelf water volume anomaly South MAB")

astsa::ccf2(diff(North_rec_dev$log_recruit_devs),SHW_NMAB_winter$mean_SHW_anom, main="Log recruitment deviations & winter Shelf water volume anomaly North MAB")

```









### Northern MAB CCF
 
 Peak correlation occurs with a 1 year lag.
 
```{r Northern_mab_ccf, echo=FALSE, message=FALSE, warning=FALSE}

# ccf(North_rec_dev$log_recruit_devs,NMAB_winter_bot_89$mean_bot_T_anom)

# N_ccf_log<-ccf(North_rec_dev$log_recruit_devs,NMAB_winter_bot_89$mean_bot_T_anom, plot = F)
# N_x<-c(-11:11)
# N_y<-c(N_ccf_log$acf)
# 
# 
# N_ccf_log_tidy<-as.data.frame(cbind(N_x,N_y))
# 
# N_ccf_plot<-N_ccf_log_tidy %>% 
#   ggplot(aes(x=N_x,y=N_y))+
#   geom_col(width = .1)+
#   geom_hline(yintercept = c(.35))+
#   xlab("Lag")+
#   ylab("ACF")+
#   ggtitle("Log recruitment deviations & winter bottom temperature anomaly", subtitle = "Northern MAB")+
#   theme_minimal()
# 
# 
# plot(N_ccf_plot)


astsa::ccf2(diff(North_rec_dev$log_recruit_devs),NMAB_winter_bot_89$mean_bot_T_anom, main="Log recruitment deviations & winter bottom temperature anomaly")

```

```{r NMAB_scatter, echo=FALSE}

astsa::lag2.plot(NMAB_winter_bot_89$mean_bot_T_anom,diff(North_rec_dev$log_recruit_devs),5)

```



### Gulf stream wall index CCF

Differing patterns in association is observed across the north vs south. Northern MAB has -3 and -7 lags, while Southern MAB has no significant time lags that correlate with recruitment deviations.  


```{r GSI_CCF, echo=FALSE, message=FALSE, warning=FALSE}

# GSI_89<-GSI_annual %>% filter(Year %in% c(1989:2019))
# #north
# 
# # ccf(North_rec_dev$log_recruit_devs,GSI_89$Value)
# # 
# # ccf(South_rec_dev$log_recruit_devs,GSI_89$Value)
# 
# 
# N_GSI_ccf_log<-ccf(North_rec_dev$log_recruit_devs,GSI_89$Value, plot = F)
# S_GSI_ccf_log<-ccf(South_rec_dev$log_recruit_devs,GSI_89$Value, plot = F)
# 
# N_GSI_x<-c(-11:11)
# S_GSI_x<-c(-11:11)
# 
# N_GSI_y<-c(N_GSI_ccf_log$acf)
# S_GSI_y<-c(S_GSI_ccf_log$acf)
# 
# N_GSI_ccf_log_tidy<-as.data.frame(cbind(N_GSI_x,N_GSI_y))
# S_GSI_ccf_log_tidy<-as.data.frame(cbind(S_GSI_x,S_GSI_y))
# 
# 
# 
# 
# N_GSI_ccf_plot<-N_GSI_ccf_log_tidy %>% 
#   ggplot(aes(x=N_GSI_x,y=N_GSI_y))+
#   geom_col(width = .1)+
#   geom_hline(yintercept = c(.35))+
#   xlab("Lag")+
#   ylab("ACF")+
#   ggtitle("Log recruitment deviations & Gulf stream wall index", subtitle = "Northern MAB")+
#   theme_minimal()
# 
# 
# S_GSI_ccf_plot<-S_GSI_ccf_log_tidy %>% 
#   ggplot(aes(x=S_GSI_x,y=S_GSI_y))+
#   geom_col(width = .1)+
#   geom_hline(yintercept = c(.35))+
#   xlab("Lag")+
#   ylab("ACF")+
#   ggtitle("Log recruitment deviations & Gulf stream wall index", subtitle = "Southern MAB")+
#   theme_minimal()
# 
# plot(N_GSI_ccf_plot)
# plot(S_GSI_ccf_plot)




```



## Indicator cross correlations 

All indicators are reverted to their respective anomaly values and tested for correlations across differing lags. indicators for each region are tested for potental differences. 

### Winter bottom temperature vs Shelf water volume

No meaningful correlations detected across time lags across ether region between winter bottom temperature and Shelf water volume


```{r indicator cross correlations_ temp_ SHW, echo=FALSE, message=FALSE, warning=FALSE}
# temp anomoly correlation with shelf water anomoly

astsa::lag2.plot

S_temp_anom_SHW_anom_log<-ccf(SMAB_winter_bot$mean_bot_T_anom, SHW_SMAB_winter$mean_SHW_anom,  type = "correlation", plot = F )

N_temp_anom_SHW_anom_log<-ccf(NMAB_winter_bot$mean_bot_T_anom, SHW_NMAB_winter$mean_SHW_anom,  type = "correlation" , plot = F)


S_temp_anom_SHW_anom_x<-c(-11:11)
N_temp_anom_SHW_anom_x<-c(-11:11)

S_temp_anom_SHW_anom_y<-c(S_temp_anom_SHW_anom_log$acf)
N_temp_anom_SHW_anom_y<-c(N_temp_anom_SHW_anom_log$acf)

N_temp_anom_SHW_anom_log_tidy<-as.data.frame(cbind(N_temp_anom_SHW_anom_x,N_temp_anom_SHW_anom_y))
S_temp_anom_SHW_anom_log_tidy<-as.data.frame(cbind(S_temp_anom_SHW_anom_x,S_temp_anom_SHW_anom_y))


N_temp_anom_SHW_anom_plot<-N_temp_anom_SHW_anom_log_tidy %>% 
  ggplot(aes(x=N_temp_anom_SHW_anom_x ,y=N_temp_anom_SHW_anom_y))+
  geom_col(width = .1)+
  geom_hline(yintercept = c(.35))+
  xlab("Lag")+
  ylab("ACF")+
  ggtitle("Winter bottom temperature & winter shelf water volume anomoly", subtitle = "Northern MAB")+
  theme_minimal()

S_temp_anom_SHW_anom_plot<-S_temp_anom_SHW_anom_log_tidy %>% 
  ggplot(aes(x=S_temp_anom_SHW_anom_x ,y=S_temp_anom_SHW_anom_y))+
  geom_col(width = .1)+
  geom_hline(yintercept = c(.35))+
  xlab("Lag")+
  ylab("ACF")+
  ggtitle("Winter bottom temperature & winter shelf water volume anomoly", subtitle = "Southern MAB")+
  theme_minimal()

plot(N_temp_anom_SHW_anom_plot)
plot(S_temp_anom_SHW_anom_plot)

```


### Winter bottom salinity vs Shelf water volume

Southern MAB displays some correlations between variables at the 5 and 8 year lag, while northern MAB has a negitive correlation at a one year lag.


```{r indicator cross correlations_salinity_SHW, echo=FALSE, message=FALSE, warning=FALSE}

# winter bottom salinity anomoly correlation with  shelf water volume anomoly



S_S_anom_SHW_anom_log<-ccf(SMAB_winter_bot$mean_bot_S_anom, SHW_SMAB_winter$mean_SHW_anom,  type = "correlation" , plot = F)
N_S_anom_SHW_anom_log<-ccf(NMAB_winter_bot$mean_bot_S_anom, SHW_NMAB_winter$mean_SHW_anom,  type = "correlation" , plot = F)


S_S_anom_SHW_anom_x<-c(-11:11)
N_S_anom_SHW_anom_x<-c(-11:11)

S_S_anom_SHW_anom_y<-c(S_S_anom_SHW_anom_log$acf)
N_S_anom_SHW_anom_y<-c(N_S_anom_SHW_anom_log$acf)

S_S_anom_SHW_anom_log_tidy<-as.data.frame(cbind(S_S_anom_SHW_anom_x,S_S_anom_SHW_anom_y))
N_S_anom_SHW_anom_log_tidy<-as.data.frame(cbind(N_S_anom_SHW_anom_x,N_S_anom_SHW_anom_y))


S_S_anom_SHW_anom_plot<-S_S_anom_SHW_anom_log_tidy %>% 
  ggplot(aes(x=S_S_anom_SHW_anom_x  ,y=S_S_anom_SHW_anom_y))+
  geom_col(width = .1)+
  geom_hline(yintercept = c(.35,-0.35))+
  xlab("Lag")+
  ylab("ACF")+
  ggtitle("Winter bottom salinity anomaly & winter shelf water volume anomaly", subtitle = "Southern MAB")+
  theme_minimal()

N_S_anom_SHW_anom_plot<-N_S_anom_SHW_anom_log_tidy %>% 
  ggplot(aes(x=N_S_anom_SHW_anom_x  ,y=N_S_anom_SHW_anom_y))+
  geom_col(width = .1)+
  geom_hline(yintercept = c(.35,-0.35))+
  xlab("Lag")+
  ylab("ACF")+
  ggtitle("Winter bottom salinity anomaly & winter shelf water volume anomaly", subtitle = "Northern MAB")+
  theme_minimal()

plot(S_S_anom_SHW_anom_plot)
plot(N_S_anom_SHW_anom_plot)

```




```{r indicator cross correlations_ temp_salinity, echo=FALSE, message=FALSE, warning=FALSE}
# winter bottom temp anomoly correlations with winter bottom salinity 


S_S_temp_log<-ccf(SMAB_winter_bot$mean_bot_S_anom, SMAB_winter_bot$mean_bot_T_anom,  type = "correlation" , plot = F)

N_S_temp_log<-ccf(NMAB_winter_bot$mean_bot_S_anom, NMAB_winter_bot$mean_bot_T_anom,  type = "correlation" , plot = F)

S_S_temp_x<-c(-11:11)
N_S_temp_x<-c(-11:11)

S_S_temp_y<-c(S_S_temp_log$acf)
N_S_temp_y<-c(N_S_temp_log$acf)

S_S_temp_log_tidy<-as.data.frame(cbind(S_S_temp_x,S_S_temp_y))
N_S_temp_log_tidy<-as.data.frame(cbind(N_S_temp_x,N_S_temp_y))


S_S_temp_plot<-S_S_temp_log_tidy %>% 
  ggplot(aes(x=S_S_temp_x  ,y=S_S_temp_y))+
  geom_col(width = .1)+
  geom_hline(yintercept = c(.35))+
  xlab("Lag")+
  ylab("ACF")+
  ggtitle("Winter bottom salinity anomaly & winter bottom temp anomaly", subtitle = "Southern MAB")+
  theme_minimal()

N_S_temp_plot<-N_S_temp_log_tidy %>% 
  ggplot(aes(x=N_S_temp_x  ,y=N_S_temp_y))+
  geom_col(width = .1)+
  geom_hline(yintercept = c(.35))+
  xlab("Lag")+
  ylab("ACF")+
  ggtitle("Winter bottom salinity anomaly & winter bottom temp anomaly", subtitle = "Northern MAB")+
  theme_minimal()

plot(S_S_temp_plot)
plot(N_S_temp_plot)


```




