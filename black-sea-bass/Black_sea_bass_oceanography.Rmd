---
title: "BSB Oceanography"
author: "Ricky Tabandera"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
# library("readxl")

```



```{r Excel_cleaning, include=FALSE}

# SHW_SMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\ShelfWaterVolume_BSB_update.xlsx",sheet =1)
# SHW_NMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\ShelfWaterVolume_BSB_update.xlsx",sheet =2)
# SHW_MAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\ShelfWaterVolume_BSB_update.xlsx",sheet =3)
# 
# SHW_SMAB %>% write.csv("SHW_SMAB.csv")
# SHW_NMAB %>% write.csv("SHW_NMAB.csv")
# SHW_MAB %>% write.csv("SHW_MAB.csv")
# 
# 
# TSanom_WGOM<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 1)
# TSanom_WGB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 2)
# TSanom_SMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 3)
# TSanom_NMAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 4)
# TSanom_MAB<-readxl::read_xlsx("~\\EDAB\\esp_data_aggregation\\black-sea-bass\\MAB_GoM_WGB_regAvg_TSanom_BSB.xlsx",sheet = 5)
# 
# 
# TSanom_WGOM  %>% write.csv("TSanom_WGOM.csv")
# TSanom_WGB  %>% write.csv("TSanom_WGB.csv")
# TSanom_SMAB  %>% write.csv("TSanom_SMAB.csv")
# TSanom_NMAB %>% write.csv("TSanom_NMAB.csv")
# TSanom_MAB %>% write.csv("TSanom_MAB.csv")



SHW_SMAB <- read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\SHW_SMAB.csv")
SHW_NMAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\SHW_NMAB.csv")
SHW_MAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\SHW_MAB.csv")



TSanom_WGOM<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_WGOM.csv")
TSanom_WGB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_WGB.csv")
TSanom_SMAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_SMAB.csv")
TSanom_NMAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_NMAB.csv")
TSanom_MAB<-read.csv("~\\EDAB\\esp_data_aggregation\\data\\Oceanography\\TSanom_MAB.csv")




############## mutate data to incude season

#convert decimal year to date
SHW_SMAB$date_ymd<-lubridate::date_decimal(SHW_SMAB$Year, tz = "UTC")
SHW_NMAB$date_ymd<-lubridate::date_decimal(SHW_NMAB$Year, tz = "UTC")
SHW_MAB$date_ymd<-lubridate::date_decimal(SHW_MAB$Year, tz = "UTC")

#extract month


SHW_SMAB$month<-lubridate::month(SHW_SMAB$date_ymd) 
SHW_NMAB$month<-lubridate::month(SHW_NMAB$date_ymd) 
SHW_MAB$month<-lubridate::month(SHW_MAB$date_ymd) 
######## extract year

SHW_SMAB$year<-lubridate::year(SHW_SMAB$date_ymd)
SHW_NMAB$year<-lubridate::year(SHW_NMAB$date_ymd)
SHW_MAB$year<-lubridate::year(SHW_MAB$date_ymd)

# limit to just winter months feb-mar as jan is irregularly avalible 
#very few december measurments

SHW_SMAB<-SHW_SMAB %>%
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  ) 



                     
SHW_SMAB<-SHW_SMAB %>% 
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )    

SHW_NMAB<-SHW_NMAB %>%  
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )


SHW_MAB<-SHW_MAB %>% 
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )

#summerize to mean winter for each variable of interest 
SHW_SMAB_winter <-SHW_SMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom), ShW.T.anom)
                         
SHW_NMAB_winter <-SHW_NMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))

 SHW_MAB_winter <-SHW_MAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))
 
#Fall 
 
SHW_SMAB_fall <-SHW_SMAB %>% filter(season=="fall") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))
                         
SHW_NMAB_fall <-SHW_NMAB %>% filter(season=="fall") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom))

 SHW_MAB_fall <-SHW_MAB %>% filter(season=="fall") %>% group_by(year) %>% summarise(mean_SHW=mean(ShW.Vol,na.rm=T ),mean_SHW_anom=mean(ShW.Vol.anom,na.rm=T ), mean_SHW_T=mean(ShW.T,na.rm=T),mean_SHW_T_anom=mean( ShW.T.anom)) 
 
######### calculate anomoly for bottom T and S
 

TSanom_SMAB<-TSanom_SMAB %>% mutate(T_anom = (T -Annual.Avg.T),S_anom = S -Annual.Avg.S)
TSanom_NMAB<-TSanom_NMAB %>% mutate(T_anom = (T -Annual.Avg.T),S_anom = S -Annual.Avg.S)



 
 
 
#convert decimal year to date
TSanom_WGOM$year_date<-lubridate::date_decimal(TSanom_WGOM$Year, tz = "UTC")
#extract month

TSanom_WGOM$month<-lubridate::month(TSanom_WGOM$year_date) 
TSanom_WGOM$year<-lubridate::year(TSanom_WGOM$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_WGOM<-TSanom_WGOM %>%  
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )
                         


#################### convert decimal date to month and classify to a season 


#convert decimal year to date
TSanom_WGB$year_date<-lubridate::date_decimal(TSanom_WGB$Year, tz = "UTC")
#extract month

TSanom_WGB$month<-lubridate::month(TSanom_WGB$year_date) 
TSanom_WGB$year<-lubridate::year(TSanom_WGB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_WGB<-TSanom_WGB %>% 
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )
                         


#convert decimal year to date
TSanom_SMAB$year_date<-lubridate::date_decimal(TSanom_SMAB$Year, tz = "UTC")
#extract month

TSanom_SMAB$month<-lubridate::month(TSanom_SMAB$year_date) 
TSanom_SMAB$year<-lubridate::year(TSanom_SMAB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_SMAB<-TSanom_SMAB %>%   
    mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )


#convert decimal year to date
TSanom_NMAB$year_date<-lubridate::date_decimal(TSanom_NMAB$Year, tz = "UTC")
#extract month

TSanom_NMAB$month<-lubridate::month(TSanom_NMAB$year_date) 
TSanom_NMAB$year<-lubridate::year(TSanom_NMAB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_NMAB<-TSanom_NMAB %>% 
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )                   
                         



###########################
#convert decimal year to date
TSanom_MAB$year_date<-lubridate::date_decimal(TSanom_MAB$Year, tz = "UTC")
#extract month
TSanom_MAB$month<-lubridate::month(TSanom_MAB$year_date) 
TSanom_MAB$year<-lubridate::year(TSanom_MAB$year_date)
# limit to just winter months jan-mar
#no december measurments
                     
TSanom_MAB<-TSanom_MAB %>% 
  mutate(season=dplyr::case_when(
  month == 1 ~ "NA",
  month == 2 | month == 3 ~ "winter",
  month <= 4 | month < 6 ~ "spring",
  month < 6 | month <= 8 ~ "summer",
  month <= 9 | month < 12 ~ "fall"
  )
  ) %>%
  
  mutate(quarter=dplyr::case_when(
  month == 1 | month == 2 | month == 3 ~ "Q1",
  month == 4 | month == 5 | month == 6 ~ "Q2",
  month == 7 | month == 8 | month == 9 ~ "Q3",
  month == 10 | month == 11 | month == 12 ~ "Q4",
  )
  )




########################

# calculate winter means and filter to only winter values


WGOM_winter_bot<-TSanom_WGOM %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ))

WGB_winter_bot<-TSanom_WGB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ))

SMAB_winter_bot<-TSanom_SMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ),mean_bot_T_anom=mean(T_anom,na.rm=T), mean_bot_S_anom=mean(S_anom,na.rm=T ) )

NMAB_winter_bot<-TSanom_NMAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ),mean_bot_T_anom=mean(T_anom,na.rm=T), mean_bot_S_anom=mean(S_anom,na.rm=T ))

MAB_winter_bot<-TSanom_MAB %>% filter(season=="winter") %>% group_by(year) %>% summarise(mean_bot_T=mean(T,na.rm=T ),mean_bot_S=mean(S,na.rm=T ))
 

write.csv(SMAB_winter_bot, file="SMAB_winter_bot.csv")
write.csv(NMAB_winter_bot, file="NMAB_winter_bot.csv")





```

## Shelf water volume

Shelf water volume which is a measure of the volume of water bounded inshore of a hydrodynamic feature called the shelf-slope front. In this analysis the shelf water is defined as all water having salinity <34. It is hypothesized that fish are migrating from the self edge and using the shelf slope font as a way-point. The position of this front will vary inter-annually with the higher values indicating the front being pushed further towards the shelf break. As this font moves closer or further from the coast, the available susceptible habitat can expand or contract as black sea bass are known to concentrate slope ward of the front. Miller et al. 2016 Identified a negative impact on catches of both juveniles and adult black sea bass when shelf water volume exceeded 4000 km^3

```{r Shelf water volume, eval=FALSE, warning=FALSE, include=FALSE}
SHW_SMAB_plot<-SHW_SMAB %>% 
  ggplot2::ggplot()+
  geom_line(aes(x=Year, y=ShW.Vol), width = .51, color="black",fill="lightgrey")+
  geom_point(aes(x=Year, y=ShW.Vol))+
  geom_hline(yintercept = 0)+
  ylab(expression(Shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(1000,6000, by= 1000))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Southern Mid Atlantic Bight")

SHW_NMAB_plot<-SHW_NMAB %>% 
  ggplot2::ggplot()+
  geom_line(aes(x=Year, y=ShW.Vol), width = .51, color="black",fill="lightgrey")+
  geom_point(aes(x=Year, y=ShW.Vol))+
  ylab(expression(Shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(1000,6000, by= 1000))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("Northern Mid Atlantic Bight")

SHW_MAB_plot<-SHW_MAB %>% 
  ggplot2::ggplot()+
  geom_line(aes(x=Year, y=ShW.Vol), width = .51, color="black",fill="lightgrey")+
  geom_point(aes(x=Year, y=ShW.Vol))+
  geom_hline(yintercept = 0)+
  ylab(expression(Shelf~water~volume~km^{"3"}))+
  scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  scale_y_continuous(breaks = seq(1000,6000, by= 1000))+
  geom_hline(yintercept=4000, linetype="dashed", color = "red")+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
  ggtitle("All Mid Atlantic Bight")





  
```

```{r SHW_PLOTS, eval=FALSE, include=FALSE}
plot(SHW_SMAB_plot)
plot(SHW_NMAB_plot)
plot(SHW_MAB_plot)


## Regional in-situ winter bottom temperature and salinity with anomaly

All available CTD data within 10m of the bottom between the northern and southern MAB region and as a whole. Regional time series were computed as follows: area-weighted regional mean values were computed for each survey in the OCDBS and a reference annual cycle was removed (fit to observations from 1981-2010) to get seasonal anomalies. 

note: winter coverage is very sparse due to the winter ECOMON surveys ending. A better approach may to be to use a two month span at the end of winter where coverage is better i.e. FEB-MAR rather than a whole winter. 


```{r regional_t_s_plots, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# TSanom_WGOM_T_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# 
# 
# TSanom_WGOM_S_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# #####################
# 
# TSanom_WGB_T_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# TSanom_WGB_S_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# #################
# TSanom_SMAB_T_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# 
# 
# TSanom_SMAB_S_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# #######  
# 
# TSanom_NMAB_T_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
# 
# 
# 
# TSanom_NMAB_S_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
#   
# #############
# 
# 
# TSanom_MAB_T_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
# 
# 
# 
# TSanom_MAB_S_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
#   
# plot(TSanom_WGOM_T_plot)
# plot(TSanom_WGOM_S_plot)
# 
# plot(TSanom_WGB_T_plot)
# plot(TSanom_WGB_S_plot)
# 
# 
# plot(TSanom_SMAB_T_plot)
# plot(TSanom_SMAB_S_plot)
# 
# plot(TSanom_NMAB_T_plot)
# plot(TSanom_NMAB_S_plot)
# 
# plot(TSanom_MAB_T_plot)
# plot(TSanom_MAB_S_plot)

```

```{r regional_t_s_anom_plots, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# TSanom_WGOM_Tanom_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y= (`T`-Annual.Avg.T) ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# 
# 
# TSanom_WGOM_S_plot<-TSanom_WGOM %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Gulf of Maine")
# 
# #####################
# 
# TSanom_WGB_T_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# TSanom_WGB_S_plot<-TSanom_WGB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Western Georges Bank")
# 
# 
# 
# #################
# TSanom_SMAB_T_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# 
# 
# TSanom_SMAB_S_plot<-TSanom_SMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Southern Mid Atlantic Bight")
# 
# #######  
# 
# TSanom_NMAB_T_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
# 
# 
# 
# TSanom_NMAB_S_plot<-TSanom_NMAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("Northern Mid Atlantic Bight")
#   
# #############
# 
# 
# TSanom_MAB_T_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y= `T` ))+
#   geom_point(color="red")+
#   geom_line()+
#   ylab("Mean temperature(C)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
# 
# 
# 
# TSanom_MAB_S_plot<-TSanom_MAB %>% 
#   ggplot(aes(x=Year,y=as.numeric( `S` )))+
#   geom_point(color="blue")+
#   geom_line()+
#   ylab("Mean salinity (PSU)")+
#     theme(axis.text.x = element_text(angle = 90),
#         panel.border= element_blank(),
#         panel.background= element_rect(fill = "white"))+
#    scale_x_continuous(breaks = seq(1977,2021, by= 1))+
#   ggtitle("All Mid Atlantic Bight")
#   
# plot(TSanom_WGOM_T_plot) 
# plot(TSanom_WGOM_S_plot)
# 
# plot(TSanom_WGB_T_plot)
# plot(TSanom_WGB_S_plot)
# 
# 
# plot(TSanom_SMAB_T_plot)
# plot(TSanom_SMAB_S_plot)
# 
# plot(TSanom_NMAB_T_plot)
# plot(TSanom_NMAB_S_plot)
# 
# plot(TSanom_MAB_T_plot)
# plot(TSanom_MAB_S_plot)

```


```{r winter_bottom_temp_and_salinity, echo=FALSE, message=FALSE, warning=FALSE}


WGOM_winter_bot_plot<-WGOM_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Western Gulf Of Maine")

###############

WGB_winter_bot_plot<-WGB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Western Georges bank")


####################



SMAB_winter_bot_plot<-SMAB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Southern Mid Atlantic Bight")

##################################



NMAB_winter_bot_plot<-NMAB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean winter bottom temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("Northern Mid Atlantic Bight")

##############

MAB_winter_bot_plot<-MAB_winter_bot %>%
  ggplot(aes(x=year,y=mean_bot_T))+
  geom_point(color="red")+
  geom_line()+
  ylab("Mean temperature(C)")+
    theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))+
   scale_x_continuous(breaks = seq(1977,2021, by= 1))+
  ggtitle("All Mid Atlantic Bight")


#########################


plot(WGOM_winter_bot_plot)
plot(WGB_winter_bot_plot)
plot(SMAB_winter_bot_plot)
plot(NMAB_winter_bot_plot)
plot(MAB_winter_bot_plot)


```



## Gulf Stream Index
The GSI is calculated based on the method presented by Pérez-Hernández and Joyce (2014). This gulf stream index is a position anomaly meaning the larger the value of the index the further north the northern wall of the Gulf Stream is for that year.


```{r Gulf_stream_index, echo=FALSE}
GSI<-ecodata::gsi

GSI %>%
  dplyr::mutate(Year = floor(Time)) %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Value = mean(Value)) %>%
  dplyr::mutate(hline = mean(Value)) %>%
  ggplot(aes(x=Year, y=Value))+
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::ylab("Gulf Stream position anomaly") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Gulf Stream Index") +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01),breaks = seq(1950,2021, by= 5))+
  theme(axis.text.x = element_text(angle = 90),
        panel.border= element_blank(),
        panel.background= element_rect(fill = "white"))
 


GSI_annual<-GSI %>%
  dplyr::mutate(Year = floor(Time)) %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Value = mean(Value)) %>%
  dplyr::mutate(hline = mean(Value))


```


```{r export_data, include=FALSE}

write.csv(SHW_MAB_winter, file="SHW_SMAB_winter.csv")
write.csv(SHW_NMAB_winter, file="SHW_NMAB_winter.csv")
write.csv(SHW_SMAB_winter, file="SHW_MAB_winter.csv")
# 
# 
# write.csv(NMAB_winter_bot, file="SMAB_winter_bot.csv")
# write.csv(NMAB_winter_bot, file="NMAB_winter_bot.csv")
# write.csv(NMAB_winter_bot, file="MAB_winter_bot.csv")
# 
# write.csv(GSI_annual, file = "GSI_annual.csv")


```



```{r Time series vis, echo=FALSE, message=FALSE, warning=FALSE}

S_rec_plot<-S_rec_temp %>% ggplot(aes(x= year,y=log_recruit_devs))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Log recruitment deviation")+
  ggtitle("Log recruitment deviations",subtitle = "Southern MAB")+
  theme_minimal()

N_rec_plot<-N_rec_temp %>% ggplot(aes(x= year,y=log_recruit_devs))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Log recruitment deviation")+
  ggtitle("Log recruitment deviations",subtitle = "Northern MAB")+
  theme_minimal()

rec_plot<-ggpubr::ggarrange(S_rec_plot,N_rec_plot, nrow = 2,ncol = 1)

S_temp_ts_plot<-S_rec_temp %>% ggplot(aes(x=year, y=mean_bot_T_anom))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Temperature anomaly")+
  ggtitle("Winter bottom",subtitle = "Southern MAB")+
  theme_minimal()

N_temp_ts_plot<-N_rec_temp %>% ggplot(aes(x=year, y=mean_bot_T_anom))+
  geom_point(size=2)+
  xlab("Year")+
  ylab("Temperature anomaly")+
  ggtitle("Winter bottom",subtitle = "Northern MAB")+
  theme_minimal()


temp_ts_plot<-ggpubr::ggarrange(S_temp_ts_plot,N_temp_ts_plot, nrow = 2,ncol = 1)


plot(rec_plot)

  



```


```{r temp_plots, echo=FALSE}
plot(temp_ts_plot)
```


### Pearsons correlations

#### Bottom temperature

Associations between model estimates of recruitment and environmental indicators is tested using Pearsons correlations. Mean winter bottom temperature is signifcantly correlated within year estimates of recruitment in both regions  (South. P-value = 0.012, t = 2.69, r=0.467; North, P-value = 0.013, t = 2.68, r= 0.480). No signifcant associations were found for lags of one or two years in mean bottom temperatures across regions. Temperature anomalys display a similar significance level and mangitude of associaiton to in-situ temperature values.

#### Bottom Salinity 

No significant associations found in either region (South. P-value = 0.880, t = 0.151, r=0.029; North, P-value = 0.080, t = 2.68, r= 0.353). Simiarly nither one or two year lags were found to be associated with recruitment deviation.


#### Winter Shelf water volume 
No significant associations found in either region (South, t = -1.00, p-value = 0.321, r= -0.13; North t = -1.098, p-value = 0.283, r= -0.210). Additionally no lags had significant associations for either of one or two years of winter shelf water volume. 

```{r Simple_correlation, echo=FALSE, message=FALSE, warning=FALSE}

#Join recrutment and bottom measurments by year for both regions
South_rec_join<-dplyr::left_join(South_rec_dev,SMAB_winter_bot,by="year")

North_rec_join<-dplyr::left_join(North_rec_dev,NMAB_winter_bot,by="year")

#used to test with funtions sensitive to NAs
S_rec_c<-South_rec_join %>%  na.omit()

N_rec_c<-North_rec_join %>%  na.omit()

# lag recruitment by suspected 1 or 2 year increments to check for differences in correlations 

South_rec_join$T_lag1<-dplyr::lag(South_rec_join$mean_bot_T,1)
South_rec_join$T_lag2<-dplyr::lag(South_rec_join$mean_bot_T,2)

North_rec_join$T_lag1<-dplyr::lag(North_rec_join$mean_bot_T,1)
North_rec_join$T_lag2<-dplyr::lag(North_rec_join$mean_bot_T,2)


# lag temperature anomaly to check if it improves or changes association
South_rec_join$T_A_lag1<-dplyr::lag(South_rec_join$mean_bot_T_anom,1)
South_rec_join$T_A_lag2<-dplyr::lag(South_rec_join$mean_bot_T_anom,2)

North_rec_join$T_A_lag1<-dplyr::lag(North_rec_join$mean_bot_T_anom,1)
North_rec_join$T_A_lag2<-dplyr::lag(North_rec_join$mean_bot_T_anom,2)

# correlation test within year

South_rec_cor<-South_rec_join %>%  with(cor.test(mean_bot_T, log_recruit_devs, method=c("pearson")))
#significant P= 0.012, r= 0.467

#correlation test with temperature lagged by 1 year I.E  2000 recruitment as a result of 1999 winter
South_rec_cor_lag1<-South_rec_join %>%  with(cor.test(T_lag1, log_recruit_devs, method=c("pearson")))
#non significant and low r estimate


# correlation test with temperature lagged by 2 year I.E  2000 recruitment as a result of 1998 winter 
South_rec_cor_lag2<-South_rec_join %>%  with(cor.test(T_lag2, log_recruit_devs, method=c("pearson")))
# non-significant and negitive r value


# correlation test with temperature anomaly display near identical pattern of within year correlations but no associations when lagged by 1 or 2

South_rec_cor_A<-South_rec_join %>%  with(cor.test(mean_bot_T_anom, log_recruit_devs, method=c("pearson")))
South_rec_cor_A_lag1<-South_rec_join %>%  with(cor.test(T_A_lag1, log_recruit_devs, method=c("pearson")))
South_rec_cor_A_lag2<-South_rec_join %>%  with(cor.test(T_A_lag2, log_recruit_devs, method=c("pearson")))





####################################

#correlations within year 
North_rec_cor<-North_rec_join %>% with(cor.test(mean_bot_T  , log_recruit_devs    , method=c("pearson")))
#significant P=0.013, r=0.480


#correlation test with temperature lagged by 1 year I.E  2000 recruitment as a result of 1999 winter
North_rec_cor_lag1<-North_rec_join %>% with(cor.test(T_lag1 , log_recruit_devs    , method=c("pearson")))
# non-significant and low r value


#correlation test with temperature lagged by 1 year I.E  2000 recruitment as a result of 1998 winter
North_rec_cor_lag2<-North_rec_join %>% with(cor.test(T_lag2 , log_recruit_devs    , method=c("pearson")))
# non-significant and negitive r value

#similar pattern in north


############# visualize significant correlations 




South_rec_cor_plot<-South_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs, label=year))+
  geom_point()+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=10,y=.5,label="r =0.47, P-value=0.012")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "southern MAB")+
  geom_text(hjust=0, vjust=0)



########################## northern correlations 

N_test_log<-North_rec_join %>%  with(cor.test(mean_bot_T  , log_recruit_devs    , method=c("pearson")))

North_rec_cor_plot<-North_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs, label=year))+
  geom_point()+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=7.8,y=2,label="r =0.48, P-value=0.013")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "Northern MAB")+
  geom_text(hjust=0, vjust=0)



plot(South_rec_cor_plot)
plot(North_rec_cor_plot)


#########################################

#salinity correlations with recruitment

S_sal_log<-South_rec_join %>%  with(cor.test(mean_bot_S   , log_recruit_devs    , method=c("pearson")))

N_sal_log<-North_rec_join %>%  with(cor.test(mean_bot_S   , log_recruit_devs    , method=c("pearson")))


S_sal_log_lag1<-South_rec_join %>%  with(cor.test(lag(mean_bot_S,1)   , log_recruit_devs    , method=c("pearson")))

N_sal_log_lag1<-North_rec_join %>%  with(cor.test(lag(mean_bot_S,1 )  , log_recruit_devs    , method=c("pearson")))

S_sal_log_lag2<-South_rec_join  %>%  with(cor.test(lag(mean_bot_S,2)   , log_recruit_devs   , method=c("pearson")))

N_sal_log_lag2<-North_rec_join %>%  with(cor.test(lag(mean_bot_S,2 )  , log_recruit_devs    , method=c("pearson")))



#######################

# Shelf water volume associations



South_SHW_join<-left_join(South_rec_dev,SHW_SMAB_winter, by= "year")

North_SHW_join<-left_join(North_rec_dev,SHW_NMAB_winter, by= "year")

South_SHW_log<-South_SHW_join %>%  with(cor.test(mean_SHW   , log_recruit_devs    , method=c("pearson")))

North_SHW_log<-North_SHW_join %>%  with(cor.test(mean_SHW   , log_recruit_devs    , method=c("pearson")))

South_SHW_log_lag1<-South_SHW_join %>%  with(cor.test(lag(mean_SHW,1)   , log_recruit_devs    , method=c("pearson")))

Nouth_SHW_log_lag1<-North_SHW_join %>%  with(cor.test(lag(mean_SHW ,1)  , log_recruit_devs    , method=c("pearson")))

South_SHW_log_lag2<-South_SHW_join %>%  with(cor.test(lag(mean_SHW,2)   , log_recruit_devs    , method=c("pearson")))

North_SHW_log_lag1<-North_SHW_join %>%  with(cor.test(lag(mean_SHW ,2)  , log_recruit_devs    , method=c("pearson")))

#add in year to dots 


```


#### Within indicator correlations

indicators are evaluated for their auto correlation within years to detect if meaningful confounding occurs. 
Bottom salinity and Shelf water volume is sigificantly negitivly correlated with shelf water volume in both regions (South ,t = -12.78, P-value= 0.001, r = -0.8551866 ( North, t = -3.46, P-value= 0.001, r = -0.534). This strong association requires the selection of one of these indicators at the exclusion of the other to avoid overfitting.Shelf water volume was not associated with bottom temperature. Salinity and temperature were not significantly associated with one another in either region 

```{r between indicator cor, echo=FALSE, message=FALSE, warning=FALSE}

South_ind_join<-left_join(SMAB_winter_bot, SHW_SMAB_winter, by="year")

North_ind_join<-left_join(NMAB_winter_bot, SHW_NMAB_winter, by="year")

# Bottom T and S not correlated within year
North_ind_TS_log<-North_ind_join %>%  with(cor.test(mean_bot_T  , mean_bot_S    , method=c("pearson")))
South_ind_TS_log<-South_ind_join %>%  with(cor.test(mean_bot_T  , mean_bot_S    , method=c("pearson")))




North_ind_TSHW_log<-North_ind_join %>%  with(cor.test(mean_bot_T  , mean_SHW    , method=c("pearson")))
South_ind_TSHW_log<-South_ind_join %>%  with(cor.test(mean_bot_T  , mean_SHW    , method=c("pearson")))

North_ind_SSHW_log<-North_ind_join %>%  with(cor.test(mean_bot_S  , mean_SHW    , method=c("pearson")))
South_ind_SSHW_log<-South_ind_join %>%  with(cor.test(mean_bot_S  , mean_SHW    , method=c("pearson")))





```



#### Reanalysis product 

A high-resolution bottom temperature ocean reanalysis and model output over the period 1989 - 2021 is compared to observed ocean temperature data using methods described in Miller et. al. 2016. The in situ dataset is subject to missing data coverage due to the timing and quality of data collection platforms resulting in Southern MAB missing 3 years, while Northern MAB is missing 7 years in coverage. The reanalysis data uses numerical simulation to interpolate for areas and times where data is limited.  

```{r reanalysis bottom temp, echo=FALSE}
reanalysis_bt<-here::here("black-sea-bass", "monthly_bottom_temp.csv") %>% read.csv()


reanalysis_bt %>% group_by("Region", year)


ra_S<-reanalysis_bt %>% filter(Region =="South" & month %in% c(2,3) ) %>% group_by(year) %>% summarise( w_bt_temp= mean(bt_temp))
ra_N<-reanalysis_bt %>% filter(Region =="North" & month %in% c(2,3) ) %>% group_by(year) %>% summarise( w_bt_temp= mean(bt_temp))


# write.csv(ra_S, file = "reanalysis_bt_winter_SMAB.csv")
# write.csv(ra_N, file = "reanalysis_bt_winter_NMAB.csv")

SMAB_re_join<-left_join(ra_S,  SMAB_winter_bot, by="year")
NMAB_re_join<-left_join(ra_N,  NMAB_winter_bot, by="year")


NMAB_re_join %>%  with(cor.test(w_bt_temp,mean_bot_T, method=c("pearson")))
SMAB_re_join %>%  with(cor.test(w_bt_temp,mean_bot_T, method=c("pearson")))


SMAB_re_join_plot<-SMAB_re_join %>% ggplot(aes(x=mean_bot_T, y=w_bt_temp))+geom_point()+
  xlab(" In situ Mean winter Bottom temperature (C)")+
  ylab("Reanalysis Mean winter Bottom temperature (C)")+
  annotate("text",x=10,y=10,label="r =0.90, P-value<0.001")+
  ggtitle("Association between bottom temperature methods: insitu vs Reanalysis", subtitle = "Southern MAB")


NMAB_re_join_plot<-NMAB_re_join %>% ggplot(aes(x=mean_bot_T, y=w_bt_temp))+geom_point()+
  xlab(" In situ Mean winter Bottom temperature (C)")+
  ylab("Reanalysis Mean winter Bottom temperature (C)")+
  annotate("text",x=8,y=10,label="r =0.81, P-value<0.001")+
  ggtitle("Association between bottom temperature methods: insitu vs Reanalysis", subtitle = "Northern MAB")




plot(SMAB_re_join_plot)
plot(NMAB_re_join_plot)

```











### linear models

The association in mean winter bottom temperature is further investigated using linear models. Significant relationships were found between bottom temperature and recruitment deviation. Model residuals do not display any concerning patterns and positive relationships observed in both regions. 



```{r rec_lm, echo=FALSE}



south_lm<- lm(log_recruit_devs~mean_bot_T,data =South_rec_join)

South_res<-data.frame(residuals=south_lm$residuals,fitted=fitted(south_lm))

South_res_plot<-South_res %>% ggplot(aes(x= fitted, y=residuals))+
  geom_point()+
  ggplot2::geom_hline(yintercept =0)+
  ggtitle("Model residuals vs fitted Southern MAB")

South_lm_plot<-South_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs, label=year))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x)+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=11,y=.5,label="R^2 = 0.218,	Adj R^2 = 0.188, P-value=0.012")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "southern MAB")+
  geom_text(hjust=0, vjust=0)


#####################

North_lm<- lm(log_recruit_devs~mean_bot_T,data =North_rec_join)

North_res<-data.frame(residuals=North_lm$residuals,fitted=fitted(North_lm))

#summary(North_lm)

North_res_plot<-North_res %>% 
  ggplot(aes(x= fitted, y=residuals))+
  geom_point()+
  ggplot2::geom_hline(yintercept =0)+
  ggtitle("Model residuals vs fitted Northern MAB")

North_lm_plot<-North_rec_join %>%
  ggplot(aes(x=mean_bot_T, y=log_recruit_devs, label=year))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x)+
  xlab("Mean winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=8,y=2,label="R^2 = 0.230,	Adj R^2 = 0.199, P-value=0.015")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "Northern MAB")+
  geom_text(hjust=0, vjust=0)


plot(South_lm_plot)

plot(South_res_plot)

plot(North_lm_plot)

plot(North_res_plot)


```





```{r Reanalysis_lm, echo=FALSE}
ra_S_rec<-left_join(ra_S,South_rec_dev, by= "year")
ra_N_rec<-left_join(ra_N,North_rec_dev, by= "year")


ra_S_rec %>% with(cor.test(w_bt_temp,log_recruit_devs, method=c("pearson")))
ra_N_rec %>% with(cor.test(w_bt_temp,log_recruit_devs, method=c("pearson")))


re_rec_lm_N<-lm(log_recruit_devs~w_bt_temp,data =ra_N_rec)
summary(re_rec_lm_N)


re_rec_lm_S<-lm(log_recruit_devs~w_bt_temp,data =ra_S_rec)
summary(re_rec_lm_S)
#0.173,	Adjusted R-squared:  0.1445 

re_rec_lm<-lm(log_recruit_devs~w_bt_temp,data =ra_N_rec)
summary(re_rec_lm)
#0.2782,	Adjusted R-squared:  0.2533 P-value= 0.002




re_North_lm_plot<-ra_N_rec %>%
  ggplot(aes(x=w_bt_temp, y=log_recruit_devs, label=year))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x)+
  xlab("Reanalyis winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=8,y=2,label="R^2 = 0.278,	Adj R^2 = 0.253, P-value=0.002")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "Northern MAB")+
  geom_text(hjust=0, vjust=0)

re_North_lm_plot<-ra_N_rec %>%
  ggplot(aes(x=w_bt_temp, y=log_recruit_devs, label=year))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x)+
  xlab("Reanalyis winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=8,y=2,label="R^2 = 0.278,	Adj R^2 = 0.253, P-value=0.002")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "Northern MAB")+
  geom_text(hjust=0, vjust=0)


re_South_lm_plot<-ra_S_rec %>%
  ggplot(aes(x=w_bt_temp, y=log_recruit_devs, label=year))+
  geom_point()+
  geom_smooth(method = "lm", formula = y ~ x)+
  xlab("Reanalyis winter Bottom temperature (C)")+
  ylab("Log recrutment deviations")+
  annotate("text",x=8,y=1,label="R^2 = 0.173,	Adj R^2 = 0.144, P-value=0.019")+
  ggtitle("Black sea bass Recrutment and bottom temperature", subtitle = "Southern MAB")+
  geom_text(hjust=0, vjust=0)




plot(re_North_lm_plot)
plot(re_South_lm_plot)

```




#### Center of Gravity

```{r COG_SHW, echo=FALSE}
cog<-read.csv("C:\\Users\\ricky.tabandera\\Documents\\EDAB\\esp_data_aggregation\\black-sea-bass\\bsb_cog.csv")


cog_n<- cog %>% filter(stock=="North", variable =="Northings")
cog_s<- cog %>% filter(stock=="South", variable =="Northings")

cog_n_E<- cog %>% filter(stock=="North", variable =="Eastings")
cog_s_E<- cog %>% filter(stock=="South", variable =="Eastings")


cog_n_temp<-left_join(cog_n, ra_N, by= "year")
cog_s_temp<-left_join(cog_n, ra_S, by= "year")




cog_n_join<- left_join(cog_n, SHW_NMAB_winter, by= "year")

cog_s_join<- left_join(cog_s, SHW_SMAB_winter, by= "year")

cog_n_E_join<-left_join(cog_n_E, SHW_NMAB_winter, by= "year")
cog_s_E_join<-left_join(cog_s_E, SHW_NMAB_winter, by= "year")




cog_n_join %>%  with(cor.test(value,mean_SHW , method=c("pearson")))

cog_s_join %>%  with(cor.test(value,mean_SHW , method=c("pearson")))



cog_n_join %>% 
  ggplot(aes(x=mean_SHW,y=value))+
  geom_point()+
  xlab("Mean winter Shelf water volume (km)")+
  ylab("Center of gravity (Northings)")+
  ggtitle("Center of gravity and shelf water volume", subtitle = "Northern MAB")+
  annotate("text",x=1600,y= 4600, label="r=0.16, P-value= 0.424")

cog_s_join %>% 
  ggplot(aes(x=mean_SHW,y=value))+
  geom_point()+
  xlab("Mean winter Shelf water volume (km)")+
  ylab("Center of gravity (Northings)")+
  ggtitle("Center of gravity and shelf water volume", subtitle = "Southern MAB")+
  annotate("text",x=1200,y= 4410, label="r=0.027, P-value= 0.839")


cog_n_temp  %>%  with(cor.test(value,w_bt_temp   , method=c("pearson")))

cog_s_temp  %>%  with(cor.test(value,w_bt_temp   , method=c("pearson")))


cog_n_temp  %>% ggplot(aes(x=w_bt_temp,y=value))+geom_point()

cog_s_temp  %>% ggplot(aes(x=w_bt_temp,y=value))+geom_point()




cog_s_temp %>% 
  ggplot(aes(x=w_bt_temp,y=value))+
  geom_point()+
  xlab("Mean winter bottom temp")+
  ylab("Center of gravity (Northings)")+
  ggtitle("Center of gravity and Winter bottom temperature", subtitle = "Southern MAB")+
  annotate("text",x=7,y= 4500, label="r = -0.311, P-value = 0.077")

cog_n_temp %>% 
  ggplot(aes(x=w_bt_temp,y=value))+
  geom_point()+
  xlab("Mean winter bottom temp")+
  ylab("Center of gravity (Northings)")+
  ggtitle("Center of gravity and Winter bottom temperature", subtitle = "Northern MAB")+
  annotate("text",x=6,y= 4500, label="r = -0.4421761, P-value = 0.009")



```








