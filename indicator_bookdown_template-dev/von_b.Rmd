## von Bertalanffy growth curve

```{r setup_vonb, cache = params$cache}
# install.packages("ggrepel")
# install.packages("ggpubr")
# devtools::install_github("james-thorson/FishLife")

suppressPackageStartupMessages(library(FishLife))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(nlstools))
library(rfishbase)
library(ggpubr)
library(FSA)
```

```{r data_wrangling, cache = params$cache, cache.lazy = FALSE}

#survdata <- readRDS(here::here("data", "survdat_pull_bio.rds"))

#load bio survdat information from the package
survdata.w.codes <- NEesp::common_names_survdat("bio")

# selected.surv <- survdata.w.codes %>%
#   stringr::str_to_sentence()) %>%
#   dplyr::filter(common_name == species)


selected.surv <- survdata.w.codes %>%
  dplyr::filter(common_name == "Black sea bass")


# only take records with age associated
selected.surv.clean <- selected.surv %>% drop_na(AGE)
```

```{r, vonb_model}
if (selected.surv.clean$AGE %>% unique() %>% length() >= 3) {
  # define the type of von b model
  vb <- vbFuns(param = "Typical")
  # define starting parameters based on the avalible data
  f.starts <- FSA::vbStarts(LENGTH ~ AGE, data = selected.surv.clean, methLinf = "oldAge")

  # fit a non-linear least squares model based on the data and starting values
  f.fit <- nls(LENGTH ~ vb(AGE, Linf, K, t0), data = selected.surv.clean, start = f.starts)
  # store the fit parameters for later investigation
  f.fit.summary <- summary(f.fit, correlation = TRUE)

  # define the range of age values that will be used to generate points from the fitted model
  # roughly by 0.2 year steps
  newages <- data.frame(AGE = seq(0, 50, length = 250))
  # predict(f.fit,newdata=newages) this funtion uses the model from f.fit to generate new lengths
  # make a dataset with the values from the model
  selected.surv.vonb <- data.frame(AGE = seq(1, 50, length = 250), LENGTH = predict(f.fit, newdata = newages))
} else {
  print("NOT ENOUGH DATA TO FIT A CURVE")
}
```

### Length at age growth curve

The predicted von Bertalanffy growth curve for NMFS managed fish species. Growth parameters of `Linf` (Length infinty), `K` (growth coefficient), and `t0` (size at time 0) were estimated using non-linear least square model. The starting point for model building is accomplished using `FSA::vbStarts`. Age and length data sourced from `survdat` and spans all years and survey areas. 

`r if(params$species == "Monkfish"){"The age determination method for monkfish has not been validated, and the anatomic structure used has changed through time. In addition these stocks display a high degree of sexual dimorphisms making fitting of single growth curves unreliable.  This results a high degree of uncertainty in assessing the age structure of the stock and the effects of fishing pressure."}`


```{r single-growth-curve, fig.cap = paste(species, "length at age growth curve")}
# palette
if (nrow(selected.surv.clean) > 0) {
  fig <- ggplot(
    data = selected.surv.clean,
    aes(
      x = AGE,
      y = LENGTH,
      color = YEAR %>% as.numeric()
    )
  ) +
    geom_jitter(alpha = 0.5) +
    scale_color_gradientn(
      colors = nmfspalette::nmfs_palette("regional web")(4),
      name = "Year"
    ) +
    xlim(0, (1.2 * max(selected.surv.clean$AGE))) +
    ylim(0, (1.2 * max(selected.surv.clean$LENGTH, na.rm = TRUE))) +
    xlab("Age (jittered)") +
    ylab(" Total length (cm) (jittered)") +
    #ggtitle(species, subtitle = "Length at age") +
    theme_minimal()

  if (nrow(selected.surv.vonb) > 0) {
    fig <- fig +
      geom_line(
        data = selected.surv.vonb,
        inherit.aes = FALSE,
        mapping = aes(
          x = AGE,
          y = LENGTH
        ),
        color = "blue",
        size = 1.4
      )
  }

  print(fig)
} else {
  print("NO DATA")
}
```




```{r, growth_diff_testing}
# testing a Common Lâˆž and t0 Model.
selected.surv.vonb

if (selected.surv.clean$AGE %>% unique() %>% length() >= 3) {
  # define the type of von b model
  vb <- vbFuns(param = "Typical")
  # define starting parameters based on the avalible data
  f.starts <- FSA::vbStarts(LENGTH ~ AGE, data = selected.surv.clean, methLinf = "oldAge")

  # fit a non-linear least squares model based on the data and starting values
  f.fit <- nls(LENGTH ~ vb(AGE, Linf, K, t0), data = selected.surv.clean, start = f.starts)
  # store the fit parameters for later investigation
  f.fit.summary <- summary(f.fit, correlation = TRUE)

  # define the range of age values that will be used to generate points from the fitted model
   
  newages.int <- data.frame(AGE = seq(0, 50))
  # predict(f.fit,newdata=newages) this funtion uses the model from f.fit to generate new lengths
  # make a dataset with the values from the model
  selected.surv.vonb.int <- data.frame(AGE = seq(0, 50), LENGTH = predict(f.fit, newdata = newages.int))
  #name the predicted length col to avoid conflicts later
  selected.surv.vonb.int<-selected.surv.vonb.int %>% rename("LENGTH_predicted"="LENGTH")
  #join with original data set
  selected.surv.w.predicted <-left_join(selected.surv.clean,selected.surv.vonb.int, by="AGE" )
  #calculate residuals of predicted length and actual length
  selected.surv.w.predicted<-selected.surv.w.predicted %>% mutate("vonB.residual"=(LENGTH-LENGTH_predicted))
  #standardize growth
  selected.surv.w.predicted<-selected.surv.w.predicted %>% mutate("residual.standardized"=(vonB.residual/LENGTH_predicted))
  
} else {
  print("NOT ENOUGH DATA TO test differences")
}



```

```{r}

if(nrow(selected.surv.w.predicted)>5){
  selected.surv.w.predicted <- selected.surv.w.predicted %>%
    dplyr::mutate(Decade = ggplot2::cut_width(YEAR, width = 10, center = 1980))

    # sex codes 1 male, 2 female, 4 transitional, 0 unsexed/unknown
    selected.surv.w.predicted$SEX <- recode(selected.surv.w.predicted$SEX, "1" = "male", "2" = "female", "0" = "unknown", "4" =     "transitional")
  

pred.von.b.ancova<-lm(residual.standardized~SEX+Decade+SEX*Decade ,data = selected.surv.w.predicted)

ancova.table<-summary(pred.von.b.ancova)
colnames(ancova.table$coefficients)<-c("Estimate" ,  "Std. Error" ,"t value",   "P-value"  )
knitr::kable(ancova.table$coefficients)


}else("Not enough data to perform analysis")

```
```{r}
if(){
  
selected.surv.w.predicted %>% 
  ggplot(aes(x=SEX, y=residual.standardized, fill=Decade))+
  geom_boxplot()+
  nmfspalette::scale_fill_nmfs()+
  labs(xlab="Sex", ylab="standarized residuals")
}
```

